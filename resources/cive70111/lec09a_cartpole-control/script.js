class CartPoleDemo{constructor(){if(this.competitionMode=!1,this.competitionBestScore=0,this.competitionUsername=null,this.leaderboard=null,this.lastRenderTime=null,this.renderInterval=1e3/60,this.canvas=document.getElementById("cartpole-canvas"),!this.canvas)return void console.error("CartPole canvas not found");const{ctx:ctx,displayWidth:displayWidth,displayHeight:displayHeight}=CanvasHelper.setupHighDPI(this.canvas);this.ctx=ctx,this.displayWidth=displayWidth,this.displayHeight=displayHeight,this.env=new CartPoleEnvironment,this.scale=100,this.cartWidth=110,this.cartHeight=40,this.trackY=this.displayHeight/2+50,this.centerX=this.displayWidth/2,this.keysPressed={},this.lastAction=0,this.score=0,this.terminated=!1,this.terminationReason=null,this.isStarted=!1,this.countdownValue=null,this.countdownActive=!1,this.stepMs=1e3*this.env.tau,this.lastTimestamp=null,this.accumulator=0,this.metricDisplays=this.createMetricDisplays(),this.initializeLeaderboard(),this.bindEvents(),this.reset(),this.loop=this.loop.bind(this),requestAnimationFrame(this.loop)}createMetricDisplays(){return{position:new MetricLabel("metric-position","x",{theme:"blue",unit:"m",decimals:2}),velocity:new MetricLabel("metric-velocity","ẋ",{theme:"teal",unit:"m/s",decimals:2}),angle:new MetricLabel("metric-angle","θ",{theme:"purple",unit:"deg",decimals:1}),angularVelocity:new MetricLabel("metric-angular-velocity","θ̇",{theme:"indigo",unit:"rad/s",decimals:2}),score:new MetricLabel("metric-score","Score",{theme:"green",decimals:0})}}initializeLeaderboard(){this.leaderboard=new LeaderboardClient({roomId:"lec09a_cartpole-control",autoConnect:!1,debug:!0,roomConfig:{display:"CartPole Control Challenge",metrics:["score"],sortBy:"score",order:"desc",description:"Achieve the longest survival time balancing the CartPole",maxUsers:200,sessionTimeout:6e5},scoreFormat:["score"],scoreLabels:{score:"Steps"},onConnect:()=>{this.competitionMode&&(document.getElementById("leaderboard-panel").style.display="block")},onDisconnect:()=>{this.leaderboard.updateStatus("Disconnected","disconnected")},onLeaderboardUpdate:data=>{this.leaderboard.updateLeaderboard(data),this.leaderboard.updateUserPositionFromLeaderboard(data)},onPositionUpdate:position=>{this.leaderboard.updateUserPosition(position)},onError:error=>{this.leaderboard.updateStatus("Connection error","disconnected")},onStatusChange:status=>{if("error"===status)this.leaderboard.updateStatus("Server unavailable","disconnected");else if("joined"===status){const statusElement=document.getElementById("status-text");if(statusElement&&statusElement.textContent.includes("DEBUG / LOCAL TESTING")){const statusDot=document.getElementById("status-dot");statusDot&&(statusDot.className="status-indicator connected")}else this.leaderboard.updateStatus("Competition active","connected")}},onUsernameAssigned:username=>{this.competitionUsername=username,document.getElementById("competition-username-display").textContent=username,"block"===document.getElementById("leaderboard-panel").style.display&&(document.getElementById("username-display-competition").style.display="block")}})}handleTabChange(tabName){const wasCompetitionMode=this.competitionMode,isCompetitionTab="competition"===tabName;isCompetitionTab&&!wasCompetitionMode?this.enterCompetitionMode():!isCompetitionTab&&wasCompetitionMode&&this.exitCompetitionMode()}enterCompetitionMode(){this.competitionMode=!0,document.getElementById("leaderboard-panel").style.display="block",document.getElementById("username-display-competition").style.display="none",this.leaderboard.connect().then(()=>{this.leaderboard.setUserId("generate-username"),this.leaderboard.join()}),this.reset(),console.log("Entered competition mode")}exitCompetitionMode(){this.competitionMode=!1,this.leaderboard.leave(),document.getElementById("leaderboard-panel").style.display="none",document.getElementById("username-display-competition").style.display="none",this.reset(),console.log("Exited competition mode")}submitCompetitionScore(){this.competitionMode&&this.leaderboard.isReady()&&this.score>this.competitionBestScore&&(this.competitionBestScore=this.score,this.leaderboard.updateScores({score:this.score},{timestamp:Date.now()}),console.log(`New best score submitted: ${this.score}`))}bindEvents(){this.keydownHandler=event=>{const key=event.key.toLowerCase();"arrowleft"!==key&&"arrowright"!==key&&"a"!==key&&"d"!==key||(event.preventDefault(),this.keysPressed[key]=!0)},this.keyupHandler=event=>{const key=event.key.toLowerCase();"arrowleft"!==key&&"arrowright"!==key&&"a"!==key&&"d"!==key||(this.keysPressed[key]=!1)},window.addEventListener("keydown",this.keydownHandler),window.addEventListener("keyup",this.keyupHandler);const startButton=document.getElementById("start-btn");startButton&&startButton.addEventListener("click",()=>this.startCountdown());const resetButton=document.getElementById("reset-btn");resetButton&&resetButton.addEventListener("click",()=>this.reset())}reset(){this.env.reset(),this.score=0,this.lastAction=0,this.terminated=!1,this.terminationReason=null,this.isStarted=!1,this.countdownValue=null,this.countdownActive=!1,this.accumulator=0,this.lastTimestamp=null,this.lastRenderTime=null,this.updateMetrics(),this.render()}startCountdown(){if(this.countdownActive||this.isStarted)return;this.reset(),this.countdownActive=!0,this.countdownValue=3;const countdownInterval=setInterval(()=>{this.countdownValue>0?this.countdownValue--:(clearInterval(countdownInterval),this.countdownActive=!1,this.countdownValue=null,this.isStarted=!0)},1e3)}loop(timestamp){null===this.lastTimestamp&&(this.lastTimestamp=timestamp);const delta=Math.min(timestamp-this.lastTimestamp,100);if(this.lastTimestamp=timestamp,this.isStarted&&!this.terminated)for(this.accumulator+=delta;this.accumulator>=this.stepMs&&!this.terminated;){const action=this.getActionFromInput();this.lastAction=action;const result=this.env.step(action);this.score+=result.reward,this.accumulator-=this.stepMs,result.done&&(this.terminated=!0,this.terminationReason=result.info&&result.info.reason?result.info.reason:"Episode terminated",this.accumulator=0,this.competitionMode&&this.submitCompetitionScore())}this.updateMetrics(),(!this.lastRenderTime||timestamp-this.lastRenderTime>=this.renderInterval)&&(this.render(),this.lastRenderTime=timestamp),requestAnimationFrame(this.loop)}getActionFromInput(){const left=this.keysPressed.arrowleft||this.keysPressed.a,right=this.keysPressed.arrowright||this.keysPressed.d;return left&&!right?1:right&&!left?2:0}updateMetrics(){const state=this.env.state||{x:0,x_dot:0,theta:0,theta_dot:0},angleDegrees=180*state.theta/Math.PI;MetricLabel.batchUpdate([{display:this.metricDisplays.position,value:state.x},{display:this.metricDisplays.velocity,value:state.x_dot},{display:this.metricDisplays.angle,value:angleDegrees},{display:this.metricDisplays.angularVelocity,value:state.theta_dot},{display:this.metricDisplays.score,value:this.score}])}render(){this.ctx.clearRect(0,0,this.displayWidth,this.displayHeight),this.drawBackground(),this.drawTrack(),this.drawCartAndPole(),this.drawActionIndicator(),this.terminated&&this.drawTerminationOverlay(),this.countdownActive&&this.drawCountdown()}drawBackground(){const gradient=this.ctx.createLinearGradient(0,0,0,this.displayHeight);gradient.addColorStop(0,"#f8fafc"),gradient.addColorStop(1,"#eef2ff"),this.ctx.fillStyle=gradient,this.ctx.fillRect(0,0,this.displayWidth,this.displayHeight),this.ctx.fillStyle="#0f172a",this.ctx.font='16px "Inter", "Helvetica", sans-serif',this.ctx.fillText("Manual control: Arrow keys or A / D",20,30),this.ctx.fillStyle="#475569",this.ctx.font='13px "Inter", "Helvetica", sans-serif',this.ctx.fillText("Keep the pole upright for as long as you can",20,50)}drawTrack(){const leftX=this.centerX-this.env.xThreshold*this.scale,rightX=this.centerX+this.env.xThreshold*this.scale;this.ctx.strokeStyle="#cbd5e1",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(leftX,this.trackY),this.ctx.lineTo(rightX,this.trackY),this.ctx.stroke();const wallTop=this.trackY-150;this.ctx.fillStyle="#475569",this.ctx.strokeStyle="#1e293b",this.ctx.lineWidth=2,this.ctx.roundRect?(this.ctx.beginPath(),this.ctx.roundRect(leftX-6,wallTop,12,150,4),this.ctx.fill(),this.ctx.stroke()):(this.ctx.fillRect(leftX-6,wallTop,12,150),this.ctx.strokeRect(leftX-6,wallTop,12,150)),this.ctx.roundRect?(this.ctx.beginPath(),this.ctx.roundRect(rightX-6,wallTop,12,150,4),this.ctx.fill(),this.ctx.stroke()):(this.ctx.fillRect(rightX-6,wallTop,12,150),this.ctx.strokeRect(rightX-6,wallTop,12,150)),this.ctx.fillStyle="#475569",this.ctx.font='12px "Inter", "Helvetica", sans-serif',this.ctx.fillText("-2.4 m",leftX-25,this.trackY-150-10),this.ctx.fillText("+2.4 m",rightX-10,this.trackY-150-10)}drawCartAndPole(){const state=this.env.state||{x:0,theta:0},cartX=this.centerX+state.x*this.scale,cartY=this.trackY,cartLeft=cartX-this.cartWidth/2,cartTop=cartY-this.cartHeight/2,cartColor=this.terminated?"#fecdd3":"#1d4ed8",cartBorder=this.terminated?"#fb7185":"#0f3fad";this.drawCartBody(cartLeft,cartTop,cartColor,cartBorder),this.drawPole(cartX,cartTop,state.theta||0,cartColor)}drawCartBody(cartLeft,cartTop,cartColor,cartBorder){this.ctx.fillStyle=cartColor,this.ctx.strokeStyle=cartBorder,this.ctx.lineWidth=2,this.ctx.roundRect?(this.ctx.beginPath(),this.ctx.roundRect(cartLeft,cartTop,this.cartWidth,this.cartHeight,8),this.ctx.fill(),this.ctx.stroke()):(this.ctx.fillRect(cartLeft,cartTop,this.cartWidth,this.cartHeight),this.ctx.strokeRect(cartLeft,cartTop,this.cartWidth,this.cartHeight));const wheelY=cartTop+this.cartHeight+6,leftWheelX=cartLeft+25,rightWheelX=cartLeft+this.cartWidth-25;this.ctx.fillStyle="#0f172a",this.ctx.beginPath(),this.ctx.arc(leftWheelX,wheelY,8,0,2*Math.PI),this.ctx.arc(rightWheelX,wheelY,8,0,2*Math.PI),this.ctx.fill()}drawPole(cartX,cartTop,theta,cartColor){const pivotX=cartX,pivotY=cartTop,poleLength=2*this.env.length*this.scale,endX=pivotX+Math.sin(theta)*poleLength,endY=pivotY-Math.cos(theta)*poleLength;this.ctx.strokeStyle="#f97316",this.ctx.lineWidth=6,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(pivotX,pivotY),this.ctx.lineTo(endX,endY),this.ctx.stroke(),this.ctx.fillStyle="#334155",this.ctx.beginPath(),this.ctx.arc(pivotX,pivotY,6,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#f97316",this.ctx.beginPath(),this.ctx.arc(endX,endY,10,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle="#fb923c",this.ctx.lineWidth=2,this.ctx.stroke(),this.drawAngleArc(pivotX,pivotY,theta,cartColor)}drawAngleArc(x,y,theta,cartColor){const start=-Math.PI/2,end=start+theta,counterClockwise=theta<0;this.ctx.strokeStyle="#8b5cf6",this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(x,y,36,start,end,counterClockwise),this.ctx.stroke(),this.ctx.strokeStyle=cartColor,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(x,y),this.ctx.lineTo(x,y-36-4),this.ctx.stroke()}drawActionIndicator(){const direction=1===this.lastAction?-1:2===this.lastAction?1:0,baseX=this.centerX+(this.env.state?this.env.state.x*this.scale:0),baseY=this.trackY+45,arrowLength=60*(0===direction?.35:1),opacity=0===direction?.3:.85;this.ctx.strokeStyle=`rgba(234, 179, 8, ${opacity})`,this.ctx.fillStyle=`rgba(234, 179, 8, ${opacity})`,this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(baseX,baseY),this.ctx.lineTo(baseX+arrowLength*direction,baseY),this.ctx.stroke(),0!==direction&&(this.ctx.beginPath(),this.ctx.moveTo(baseX+arrowLength*direction,baseY),this.ctx.lineTo(baseX+arrowLength*direction-10*direction,baseY-10),this.ctx.lineTo(baseX+arrowLength*direction-10*direction,baseY+10),this.ctx.closePath(),this.ctx.fill()),this.ctx.fillStyle="#475569",this.ctx.font='12px "Inter", "Helvetica", sans-serif';const label=-1===direction?"Left force":1===direction?"Right force":"No push";this.ctx.fillText(label,baseX-35,baseY+22)}drawTerminationOverlay(){this.ctx.fillStyle="rgba(239, 68, 68, 0.14)",this.ctx.fillRect(0,0,this.displayWidth,this.displayHeight),this.ctx.fillStyle="#b91c1c",this.ctx.font='18px "Inter", "Helvetica", sans-serif',this.ctx.textAlign="center",this.ctx.fillText("Episode terminated",this.displayWidth/2,50),this.ctx.fillStyle="#ef4444",this.ctx.font='14px "Inter", "Helvetica", sans-serif';const reason=this.terminationReason||"Pole fell or cart left the track";this.ctx.fillText(reason,this.displayWidth/2,70),this.ctx.textAlign="start"}drawCountdown(){this.ctx.fillStyle="rgba(59, 130, 246, 0.1)",this.ctx.fillRect(0,0,this.displayWidth,this.displayHeight),this.ctx.textAlign="center",this.ctx.textBaseline="middle";const displayText=0===this.countdownValue?"GO!":this.countdownValue.toString(),fontSize=0===this.countdownValue?72:96,color=0===this.countdownValue?"#10b981":"#3b82f6";this.ctx.fillStyle=color,this.ctx.font=`bold ${fontSize}px "Inter", "Helvetica", sans-serif`,this.ctx.fillText(displayText,this.displayWidth/2,this.displayHeight/2),this.ctx.fillStyle="#64748b",this.ctx.font='16px "Inter", "Helvetica", sans-serif',this.ctx.fillText("Get ready...",this.displayWidth/2,this.displayHeight/2+60),this.ctx.textAlign="start",this.ctx.textBaseline="alphabetic"}}window.addEventListener("DOMContentLoaded",()=>{window.cartPoleDemo=new CartPoleDemo,new InfoTab({onTabChange:tabName=>window.cartPoleDemo.handleTabChange(tabName)})});