const GRID_SIZE=5,CELL_SIZE=70,GRID_PADDING=8,EMPTY=0,OBSTACLE=1,START=2,GOAL=3,UP=0,DOWN=1,LEFT=2,RIGHT=3,ACTIONS=[0,1,2,3],ACTION_NAMES=["↑","↓","←","→"],ACTION_DELTAS=[[-1,0],[1,0],[0,-1],[0,1]],grid=[[0,0,1,0,3],[0,0,0,0,0],[0,0,1,1,1],[0,0,0,0,0],[2,1,0,0,0]],START_POS=[4,0],GOAL_POS=[0,4],GAMMA=.9,THETA=.01,STEP_REWARD=-1,GOAL_REWARD=10;let valueCanvas,policyCanvas,agentCanvas,valueCtx,policyCtx,agentCtx,values=[],policy=[],iterationCount=0,isConverged=!1,isAnimating=!1,stopAnimation=!1;const COLORS={empty:"#ffffff",obstacle:"#6c757d",goal:"#ffc107",start:"#d1ecf1",agent:"#007bff",path:"#28a745",grid:"#dee2e6",text:"#343a40",valueText:"#007bff",policyArrow:"#28a745"};function init(){valueCanvas=document.getElementById("valueCanvas"),policyCanvas=document.getElementById("policyCanvas"),agentCanvas=document.getElementById("agentCanvas"),valueCtx=valueCanvas.getContext("2d"),policyCtx=policyCanvas.getContext("2d"),agentCtx=agentCanvas.getContext("2d"),setupCanvas(valueCanvas,valueCtx),setupCanvas(policyCanvas,policyCtx),setupCanvas(agentCanvas,agentCtx),initializeValues(),initializePolicy(),renderAll(),new InfoTab}function setupCanvas(canvas,ctx){const dpr=window.devicePixelRatio||1;canvas.width=398*dpr,canvas.height=398*dpr,canvas.style.width="398px",canvas.style.height="398px",ctx.scale(dpr,dpr)}function initializeValues(){values=[];for(let r=0;r<5;r++){values[r]=[];for(let c=0;c<5;c++)1===grid[r][c]?values[r][c]=null:values[r][c]=0}}function initializePolicy(){policy=[];for(let r=0;r<5;r++){policy[r]=[];for(let c=0;c<5;c++)1===grid[r][c]||3===grid[r][c]?policy[r][c]=null:policy[r][c]=[ACTIONS[Math.floor(Math.random()*ACTIONS.length)]]}}function isValidCell(r,c){return r>=0&&r<5&&c>=0&&c<5&&1!==grid[r][c]}function getNextState(r,c,action){const[dr,dc]=ACTION_DELTAS[action],newR=r+dr,newC=c+dc;return isValidCell(newR,newC)?[newR,newC]:[r,c]}function getReward(r,c,action){const[newR,newC]=getNextState(r,c,action);let reward=-1;return 3===grid[newR][newC]&&(reward+=10),reward}function policyEvaluationStep(){let maxDelta=0;for(let r=0;r<5;r++)for(let c=0;c<5;c++){if(1===grid[r][c]||3===grid[r][c])continue;const oldValue=values[r][c],action=policy[r][c][0],[newR,newC]=getNextState(r,c,action),reward=getReward(r,c,action);values[r][c]=reward+.9*values[newR][newC],maxDelta=Math.max(maxDelta,Math.abs(oldValue-values[r][c]))}renderValueGrid();const converged=maxDelta<.01;return document.getElementById("eval-status").textContent=converged?"Converged (Δ < 0.01)":`Δ = ${maxDelta.toFixed(4)}`,converged}function policyImprovementStep(){let policyStable=!0;for(let r=0;r<5;r++)for(let c=0;c<5;c++){if(1===grid[r][c]||3===grid[r][c])continue;const oldActions=policy[r][c];let bestActions=[],bestValue=-1/0;for(const action of ACTIONS){const[newR,newC]=getNextState(r,c,action),value=getReward(r,c,action)+.9*values[newR][newC];value>bestValue?(bestValue=value,bestActions=[action]):Math.abs(value-bestValue)<.001&&bestActions.push(action)}policy[r][c]=bestActions,arraysEqual(oldActions,bestActions)||(policyStable=!1)}return iterationCount++,renderPolicyGrid(),document.getElementById("policy-status").textContent=policyStable?"Policy Stable!":"Policy Updated",document.getElementById("iteration-count").textContent=iterationCount,document.getElementById("policy-stable").textContent=policyStable?"Yes":"No",isConverged=policyStable,policyStable}function arraysEqual(a,b){if(null===a&&null===b)return!0;if(null===a||null===b)return!1;if(a.length!==b.length)return!1;const sortedA=[...a].sort(),sortedB=[...b].sort();return sortedA.every((val,idx)=>val===sortedB[idx])}async function runUntilConvergence(){let stable=!1,iterations=0;for(;!stable&&iterations<100;){let evalConverged=!1,evalSteps=0;for(;!evalConverged&&evalSteps<100;)evalConverged=policyEvaluationStep(),evalSteps++,await sleep(50);stable=policyImprovementStep(),iterations++,await sleep(100)}stable&&(document.getElementById("eval-status").textContent="Optimal Policy Found!",document.getElementById("policy-status").textContent="Optimal Policy Found!")}function resetAll(){initializeValues(),initializePolicy(),iterationCount=0,isConverged=!1,document.getElementById("eval-status").textContent="Ready",document.getElementById("policy-status").textContent="Ready",document.getElementById("iteration-count").textContent="0",document.getElementById("policy-stable").textContent="No",document.getElementById("agent-steps").textContent="0",document.getElementById("agent-reward").textContent="0",document.getElementById("agent-status").textContent="Ready",renderAll()}function renderAll(){renderValueGrid(),renderPolicyGrid(),renderAgentGrid()}function renderValueGrid(){const ctx=valueCtx;ctx.fillStyle="#f8f9fa",ctx.fillRect(0,0,valueCanvas.width,valueCanvas.height);for(let r=0;r<5;r++)for(let c=0;c<5;c++){const x=78*c+8,y=78*r+8;if(1===grid[r][c]?ctx.fillStyle=COLORS.obstacle:3===grid[r][c]?ctx.fillStyle=COLORS.goal:2===grid[r][c]?ctx.fillStyle=COLORS.start:ctx.fillStyle=COLORS.empty,ctx.fillRect(x,y,70,70),ctx.strokeStyle=COLORS.grid,ctx.lineWidth=2,ctx.strokeRect(x,y,70,70),null!==values[r][c])if(ctx.textAlign="center",ctx.textBaseline="middle",3===grid[r][c])ctx.fillStyle=COLORS.text,ctx.font="bold 12px monospace",ctx.fillText("GOAL",x+35,y+35);else{ctx.fillStyle=COLORS.valueText,ctx.font="bold 16px monospace";const valueText=values[r][c].toFixed(2);ctx.fillText(valueText,x+35,y+35)}}}function renderPolicyGrid(){const ctx=policyCtx;ctx.fillStyle="#f8f9fa",ctx.fillRect(0,0,policyCanvas.width,policyCanvas.height);for(let r=0;r<5;r++)for(let c=0;c<5;c++){const x=78*c+8,y=78*r+8;if(1===grid[r][c]?ctx.fillStyle=COLORS.obstacle:3===grid[r][c]?ctx.fillStyle=COLORS.goal:2===grid[r][c]?ctx.fillStyle=COLORS.start:ctx.fillStyle=COLORS.empty,ctx.fillRect(x,y,70,70),ctx.strokeStyle=COLORS.grid,ctx.lineWidth=2,ctx.strokeRect(x,y,70,70),3===grid[r][c])ctx.fillStyle=COLORS.text,ctx.font="bold 12px monospace",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("GOAL",x+35,y+35);else if(null!==policy[r][c]&&policy[r][c].length>0){const actions=policy[r][c];if(ctx.fillStyle=COLORS.policyArrow,ctx.textAlign="center",1===actions.length)ctx.font="bold 24px monospace",ctx.textBaseline="middle",ctx.fillText(ACTION_NAMES[actions[0]],x+35,y+35);else{ctx.font="bold 16px monospace";const startY=y+35-18*actions.length/2+9;actions.forEach((action,idx)=>{ctx.textBaseline="middle",ctx.fillText(ACTION_NAMES[action],x+35,startY+18*idx)})}}}}function renderAgentGrid(agentPos=null,path=[]){const ctx=agentCtx;ctx.fillStyle="#f8f9fa",ctx.fillRect(0,0,agentCanvas.width,agentCanvas.height);for(let r=0;r<5;r++)for(let c=0;c<5;c++){const x=78*c+8,y=78*r+8;let fillColor=COLORS.empty;1===grid[r][c]?fillColor=COLORS.obstacle:3===grid[r][c]?fillColor=COLORS.goal:2===grid[r][c]?fillColor=COLORS.start:path.some(p=>p[0]===r&&p[1]===c)&&(fillColor=COLORS.path),ctx.fillStyle=fillColor,ctx.fillRect(x,y,70,70),ctx.strokeStyle=COLORS.grid,ctx.lineWidth=2,ctx.strokeRect(x,y,70,70),agentPos&&agentPos[0]===r&&agentPos[1]===c&&(ctx.fillStyle=COLORS.agent,ctx.beginPath(),ctx.arc(x+35,y+35,70/3,0,2*Math.PI),ctx.fill()),3!==grid[r][c]||agentPos&&agentPos[0]===r&&agentPos[1]===c||(ctx.fillStyle=COLORS.text,ctx.font="bold 12px monospace",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("GOAL",x+35,y+35))}}async function animateAgent(){if(isAnimating)return;isAnimating=!0,stopAnimation=!1,document.getElementById("animate-btn").style.display="none",document.getElementById("stop-btn").style.display="inline-block";let pos=[...START_POS];const path=[pos];let steps=0,totalReward=0;for(document.getElementById("agent-status").textContent="Running...",document.getElementById("agent-status").style.color="#007bff";3!==grid[pos[0]][pos[1]]&&steps<50&&!stopAnimation&&(renderAgentGrid(pos,path),await sleep(300),!stopAnimation);){const actions=policy[pos[0]][pos[1]],action=actions[Math.floor(Math.random()*actions.length)],[newR,newC]=getNextState(pos[0],pos[1],action),reward=getReward(pos[0],pos[1],action);pos=[newR,newC],path.push(pos),steps++,totalReward+=reward,document.getElementById("agent-steps").textContent=steps,document.getElementById("agent-reward").textContent=totalReward.toFixed(1)}stopAnimation?(document.getElementById("agent-status").textContent="Stopped",document.getElementById("agent-status").style.color="#dc3545"):3===grid[pos[0]][pos[1]]?(document.getElementById("agent-status").textContent="Goal Reached!",document.getElementById("agent-status").style.color="#28a745"):(document.getElementById("agent-status").textContent="Max Steps Reached",document.getElementById("agent-status").style.color="#dc3545"),renderAgentGrid(pos,path),document.getElementById("animate-btn").style.display="inline-block",document.getElementById("stop-btn").style.display="none",isAnimating=!1}function stopAgent(){stopAnimation=!0}function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms))}document.addEventListener("DOMContentLoaded",init);