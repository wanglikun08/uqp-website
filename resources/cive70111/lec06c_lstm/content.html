<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long Short-Term Memory (LSTM)</title>
    <script src="../phoebe-js/mathhelper.js"></script>
    <script src="../phoebe-js/canvashelper.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../phoebe-js/phoebe.css">
    <link rel="stylesheet" href="../phoebe-js/demo-common.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="iframe-content">
        <div class="container">

        <div class="infotab">
            <div class="infotab-header">
            </div>

            <div class="infotab-content">
                <div class="infotab-panel active" data-tab-title="Introduction">
                    <strong>Long Short-Term Memory (LSTM)</strong><br><br>
                    This interactive demo shows how LSTM networks process sequential data using a sophisticated gating mechanism. Unlike simple RNNs, LSTMs use gates to control information flow, allowing them to learn long-term dependencies without suffering from vanishing gradients.<br><br>
                    You'll explore how the four gates (forget, input, input node, output) work together to maintain both hidden state and cell state, enabling the network to selectively remember and forget information.<br><br>
                    <strong>Why Normalization Matters:</strong><br>
                    LSTM gates rely on sigmoid ($\sigma$) and tanh activations, which are bounded to [0,1] and [-1,1] respectively. When input values become very large (positive or negative), these activation functions saturate - sigmoid outputs stick at 0 or 1, and tanh sticks at -1 or 1. In these saturated regions, gradients vanish, preventing the network from learning. Normalizing input sequences to a bounded range (like [-1,1]) keeps values in the responsive region where activations can vary smoothly and gradients flow properly. This is critical for training LSTMs effectively.<br><br>
                    <strong>Understanding Parameter Effects:</strong><br>
                    Each gate has separate weights for current input ($W_{fx}$, $W_{ix}$, etc.) and previous hidden state ($W_{fh}$, $W_{ih}$, etc.), plus biases ($b_{fx}$, $b_{fh}$, etc.). This separation gives fine-grained control: for example, a high $W_{fx}$ means the forget gate responds strongly when the current input $x$ is large (remembering more for large inputs), while very negative values for both $b_{ih}$ and $b_{ix}$ bias the input gate to stay nearly closed regardless of inputs, effectively ignoring new information. Positive forget gate biases make the network "remember by default". These interpretable parameters let you understand and control how the LSTM processes sequences.<br><br>
                    <strong>Educational Context:</strong><br>
                    This demo uses a simplified scalar LSTM (single hidden dimension, 16 total parameters) and optimizes to intentionally overfit on a single sequence. This pedagogical approach makes parameter effects clearly visible - in real applications, you would use train/validation/test splits and vector-valued hidden states with many more parameters. The "Optimise" button finds parameters that minimize prediction error on the chosen sequence.
                </div>

                <div class="infotab-panel" data-tab-title="Theory">
                    <strong>LSTM Architecture Components:</strong><br><br>
                    • <strong>Cell State:</strong> $c_t$ - Long-term memory that flows through the network<br>
                    • <strong>Hidden State:</strong> $h_t$ - Short-term memory used for output<br>
                    • <strong>Forget Gate:</strong> $f_t$ - Decides what to discard from cell state<br>
                    • <strong>Input Gate:</strong> $i_t$ - Decides what new information to store<br>
                    • <strong>Input Node:</strong> $\tilde{c}_t$ - Creates candidate values to add to cell state<br>
                    • <strong>Output Gate:</strong> $o_t$ - Decides what to output based on cell state<br><br>
                    <strong>LSTM Formulas (with separate input/hidden weights and biases):</strong><br>
                    $f_t = \sigma(W_{fx} x_t + b_{fx} + W_{fh} h_{t-1} + b_{fh})$<br>
                    $i_t = \sigma(W_{ix} x_t + b_{ix} + W_{ih} h_{t-1} + b_{ih})$<br>
                    $\tilde{c}_t = \tanh(W_{cx} x_t + b_{cx} + W_{ch} h_{t-1} + b_{ch})$<br>
                    $o_t = \sigma(W_{ox} x_t + b_{ox} + W_{oh} h_{t-1} + b_{oh})$<br>
                    $c_t = f_t \odot c_{t-1} + i_t \odot \tilde{c}_t$<br>
                    $h_t = o_t \odot \tanh(c_t)$<br><br>
                    where $\sigma$ is sigmoid, $\odot$ is element-wise multiplication, and each gate has separate parameters for input ($x$) and hidden state ($h$) transformations.
                </div>

                <div class="infotab-panel" data-tab-title="Instructions">
                    <strong>How to Use:</strong><br><br>
                    • <em>Select a sequence</em> from the dropdown to see different patterns<br>
                    • <em>Adjust gate weights</em> to control how the LSTM processes information<br>
                    • <em>Observe how the input node</em> creates candidate values<br>
                    • <em>Use "Step Forward"</em> to manually process each timestep<br>
                    • <em>Watch gate values</em> displayed inside the LSTM cell<br>
                    • <em>Use "Optimise"</em> to find weights that predict the next sequence value<br><br>
                    <strong>Sequence Types:</strong><br>
                    • <em>Fibonacci:</em> Each number is sum of previous two<br>
                    • <em>Linear:</em> Simple counting sequence<br>
                    • <em>Alternating:</em> Pattern that switches between values<br>
                    • <em>Exponential:</em> Powers of 2 sequence<br>
                    • <em>Sine Pattern:</em> Smooth oscillating values
                </div>

                <div class="infotab-panel" data-tab-title="Tips">
                    <strong>Understanding LSTM Parameters:</strong><br><br>
                    • <strong>Input Weights ($W_{fx}$, $W_{ix}$, $W_{cx}$, $W_{ox}$):</strong> Control how each gate responds to current input. Positive values amplify input effect, negative values suppress it.<br>
                    • <strong>Hidden Weights ($W_{fh}$, $W_{ih}$, $W_{ch}$, $W_{oh}$):</strong> Control how each gate responds to previous hidden state. Enable temporal dependencies.<br>
                    • <strong>Biases ($b_{fx}$, $b_{ix}$, etc.):</strong> Set "default behavior" independent of inputs. Positive biases open gates, negative biases close them.<br><br>
                    <strong>Parameter Interpretation Examples:</strong><br>
                    • <strong>High $W_{fx}$ with negative $b_{fh}$:</strong> Forget more when input is large, remember when input is small<br>
                    • <strong>Negative $b_{ix}$ and $b_{ih}$:</strong> Input gate nearly always closed, ignoring new information<br>
                    • <strong>Positive $b_{fh}$:</strong> Forget gate biased open, remembers previous cell state by default<br>
                    • <strong>Large $W_{ch}$ with small $W_{cx}$:</strong> Input node responds more to temporal patterns than current input<br><br>
                    <strong>Gate Interactions:</strong><br>
                    • <strong>Forget + Input Gates:</strong> Work together to update cell state. If forget=1 and input=0: perfect memory. If forget=0 and input=1: complete replacement.<br>
                    • <strong>Cell State vs Hidden State:</strong> Cell state ($c_t$) uses additive updates preventing gradient vanishing. Hidden state ($h_t$) is a filtered, bounded view for output.<br>
                    • <strong>Output Gate:</strong> Controls how much cell state information reaches the hidden state and final output.
                </div>
            </div>
        </div>

        <div class="demo-area">
            <div class="plot-container">
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #2c3e50; text-align: center;">Input Sequence ($x_t$)</h4>
                    <canvas id="input-canvas" width="635" height="150"></canvas>
                </div>

                <div style="margin-bottom: 20px; position: relative;">
                    <h4 style="margin: 0 0 10px 0; color: #2c3e50; text-align: center;">LSTM Cell</h4>
                    <canvas id="lstm-canvas" width="635" height="400"></canvas>
                    <button id="step-btn" class="generate-data-btn canvas-button-left">Step Forward</button>
                    <button id="reset-btn" class="clear-data-btn canvas-button-right">Reset</button>
                    <button id="optimise-btn" class="generate-data-btn canvas-button-bottom-right">Optimise</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #2c3e50; text-align: center;">Output Sequence ($h_t$)</h4>
                    <canvas id="output-canvas" width="635" height="200"></canvas>
                </div>
            </div>

            <div class="controls">
                <div class="fancybox-panel">
                    <h4>Input Sequence</h4>
                    <div class="fancybox-container">
                        <div class="fancybox active sequence-box" data-type="fibonacci" data-color="blue" data-label="Fibonacci">
                            <svg class="sequence-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <line x1="10" y1="2" x2="10" y2="18" stroke="currentColor" stroke-width="1" opacity="0.3"/>
                                <line x1="2" y1="10" x2="18" y2="10" stroke="currentColor" stroke-width="1" opacity="0.3"/>
                                <text x="5" y="7.5" text-anchor="middle" font-size="7" font-weight="bold" fill="currentColor">1</text>
                                <text x="15" y="7.5" text-anchor="middle" font-size="7" font-weight="bold" fill="currentColor">1</text>
                                <text x="5" y="16.5" text-anchor="middle" font-size="7" font-weight="bold" fill="currentColor">2</text>
                                <text x="15" y="16.5" text-anchor="middle" font-size="7" font-weight="bold" fill="currentColor">3</text>
                            </svg>
                        </div>
                        <div class="fancybox sequence-box" data-type="linear" data-color="orange" data-label="Linear">
                            <svg class="sequence-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <line x1="2" y1="18" x2="18" y2="2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <polyline points="14,2 18,2 18,6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                            </svg>
                        </div>
                        <div class="fancybox sequence-box" data-type="alternating" data-color="purple" data-label="Alternating">
                            <svg class="sequence-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <polyline points="2,14 2,6 6,6 6,14 10,14 10,6 14,6 14,14 18,14" stroke="currentColor" stroke-width="2" stroke-linecap="square" stroke-linejoin="miter" fill="none"/>
                            </svg>
                        </div>
                        <div class="fancybox sequence-box" data-type="exponential" data-color="teal" data-label="Exponential">
                            <svg class="sequence-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 17.5 L5 17 L8 15.5 L11 12 L14 6 L17 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                            </svg>
                        </div>
                        <div class="fancybox sequence-box" data-type="sine" data-color="green" data-label="Sine">
                            <svg class="sequence-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 10 Q 5 2, 10 10 T 18 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="fancybox-panel">
                    <h4>Input Scaling</h4>
                    <div class="fancybox-container" id="input-scaling-container">
                        <div class="fancybox active" data-type="raw" data-color="blue" data-icon="#" data-label="Raw Inputs"></div>
                        <div class="fancybox" data-type="normalized" data-color="teal" data-icon="~" data-label="Normalized"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parameter Sliders Grid - Full Width -->
        <div style="width: 100%; max-width: 100%; box-sizing: border-box; margin-top: 20px;">
            <!-- Main Gate Headers -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 10px;">
                <div style="text-align: center;"><h4>Forget Gate</h4></div>
                <div style="text-align: center;"><h4>Input Gate</h4></div>
                <div style="text-align: center;"><h4>Input Node</h4></div>
                <div style="text-align: center;"><h4>Output Gate</h4></div>
            </div>

            <!-- Mini Headers Row: Input | Hidden | Input | Hidden | Input | Hidden | Input | Hidden -->
            <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 15px; margin-bottom: 5px;">
                <div style="font-size: 12px; font-weight: 600; color: #666; text-align: center;">Input</div>
                <div style="font-size: 12px; font-weight: 600; color: #666; text-align: center;">Hidden</div>
                <div style="font-size: 12px; font-weight: 600; color: #666; text-align: center;">Input</div>
                <div style="font-size: 12px; font-weight: 600; color: #666; text-align: center;">Hidden</div>
                <div style="font-size: 12px; font-weight: 600; color: #666; text-align: center;">Input</div>
                <div style="font-size: 12px; font-weight: 600; color: #666; text-align: center;">Hidden</div>
                <div style="font-size: 12px; font-weight: 600; color: #666; text-align: center;">Input</div>
                <div style="font-size: 12px; font-weight: 600; color: #666; text-align: center;">Hidden</div>
            </div>

            <!-- Sliders Grid: 8 columns (Input/Hidden pairs for each gate) -->
            <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 15px;">
                <!-- Forget Gate -->
                <div>
                    <div id="paramslider-forget-weight-input"></div>
                    <div id="paramslider-forget-bias-input"></div>
                </div>
                <div>
                    <div id="paramslider-forget-weight-hidden"></div>
                    <div id="paramslider-forget-bias-hidden"></div>
                </div>

                <!-- Input Gate -->
                <div>
                    <div id="paramslider-input-gate-weight-input"></div>
                    <div id="paramslider-input-gate-bias-input"></div>
                </div>
                <div>
                    <div id="paramslider-input-gate-weight-hidden"></div>
                    <div id="paramslider-input-gate-bias-hidden"></div>
                </div>

                <!-- Input Node -->
                <div>
                    <div id="paramslider-cell-weight-input"></div>
                    <div id="paramslider-cell-bias-input"></div>
                </div>
                <div>
                    <div id="paramslider-cell-weight-hidden"></div>
                    <div id="paramslider-cell-bias-hidden"></div>
                </div>

                <!-- Output Gate -->
                <div>
                    <div id="paramslider-output-gate-weight-input"></div>
                    <div id="paramslider-output-gate-bias-input"></div>
                </div>
                <div>
                    <div id="paramslider-output-gate-weight-hidden"></div>
                    <div id="paramslider-output-gate-bias-hidden"></div>
                </div>
            </div>
        </div>

        <!-- Sequence Processing History Table -->
        <div class="horizontal-scroll-container" style="width: 100%; max-width: 100%; overflow: hidden; box-sizing: border-box; margin-top: 20px;">
            <div class="horizontal-scroll-title">Sequence Processing History</div>
            <div class="horizontal-scroll" id="historyScroll">
                <table class="horizontal-scroll-table" id="historyTable">
                    <tbody id="historyBody">
                        <tr class="history-row-step">
                            <th>Step</th>
                            <td class="current-iteration">-</td>
                        </tr>
                        <tr class="history-row-input">
                            <th>Input (x<sub>t</sub>)</th>
                            <td class="current-iteration">-</td>
                        </tr>
                        <tr class="history-row-expected">
                            <th>Expected Next</th>
                            <td class="current-iteration">-</td>
                        </tr>
                        <tr class="history-row-cell">
                            <th>Cell State (C<sub>t</sub>)</th>
                            <td class="current-iteration">-</td>
                        </tr>
                        <tr class="history-row-output">
                            <th>Hidden State (h<sub>t</sub>)</th>
                            <td class="current-iteration">-</td>
                        </tr>
                        <tr class="history-row-error">
                            <th>Error (Δ)</th>
                            <td class="current-iteration">-</td>
                        </tr>
                        <tr class="history-row-expected-delta">
                            <th>Expected Δ Output</th>
                            <td class="current-iteration">-</td>
                        </tr>
                        <tr class="history-row-actual-delta">
                            <th>Actual Δ Output</th>
                            <td class="current-iteration">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        </div>
    </div>

    <script src="../phoebe-js/infotab.js"></script>
    <script src="../phoebe-js/paramslider.js"></script>
    <script src="../phoebe-js/metriclabel.js"></script>
    <script src="script.js"></script>
    <script>
        // Initialize the demo when the page loads
        window.addEventListener('DOMContentLoaded', function() {
            // Initialize info tabs
            new InfoTab();

            // Initialize the demo
            new LSTMDemo();
        });
    </script>
</body>
</html>
