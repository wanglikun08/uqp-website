class LSTMDemo{constructor(){this.inputCanvas=document.getElementById("input-canvas"),this.lstmCanvas=document.getElementById("lstm-canvas"),this.outputCanvas=document.getElementById("output-canvas"),this.inputCtx=this.inputCanvas.getContext("2d"),this.lstmCtx=this.lstmCanvas.getContext("2d"),this.outputCtx=this.outputCanvas.getContext("2d"),this.stepBtn=document.getElementById("step-btn"),this.resetBtn=document.getElementById("reset-btn"),this.optimiseBtn=document.getElementById("optimise-btn"),this.configureCanvases(),this.sequences={fibonacci:[1,1,2,3,5,8,13,21,34,55],linear:[1,2,3,4,5,6,7,8,9,10],alternating:[1,-1,1,-1,1,-1,1,-1,1,-1],exponential:[1,2,4,8,16,32,64,128,256,512],sine:[0,.71,1,.71,0,-.71,-1,-.71,0,.71]},this.selectedSequence="fibonacci",this.useNormalization=!1,this.setupPhoebeComponents(),this.reset(),this.setupEventListeners(),this.render()}setupPhoebeComponents(){this.forgetWeightInputSlider=new ParamSlider("paramslider-forget-weight-input",{inputId:"forget-weight-input",label:"$W_{fx}$",min:-10,max:10,step:.1,value:.8,decimals:2,onChange:()=>this.render()}),this.forgetBiasInputSlider=new ParamSlider("paramslider-forget-bias-input",{inputId:"forget-bias-input",label:"$b_{fx}$",min:-10,max:10,step:.1,value:0,decimals:2,onChange:()=>this.render()}),this.forgetWeightHiddenSlider=new ParamSlider("paramslider-forget-weight-hidden",{inputId:"forget-weight-hidden",label:"$W_{fh}$",min:-10,max:10,step:.1,value:.5,decimals:2,onChange:()=>this.render()}),this.forgetBiasHiddenSlider=new ParamSlider("paramslider-forget-bias-hidden",{inputId:"forget-bias-hidden",label:"$b_{fh}$",min:-10,max:10,step:.1,value:0,decimals:2,onChange:()=>this.render()}),this.inputGateWeightInputSlider=new ParamSlider("paramslider-input-gate-weight-input",{inputId:"input-gate-weight-input",label:"$W_{ix}$",min:-10,max:10,step:.1,value:.5,decimals:2,onChange:()=>this.render()}),this.inputGateBiasInputSlider=new ParamSlider("paramslider-input-gate-bias-input",{inputId:"input-gate-bias-input",label:"$b_{ix}$",min:-10,max:10,step:.1,value:0,decimals:2,onChange:()=>this.render()}),this.inputGateWeightHiddenSlider=new ParamSlider("paramslider-input-gate-weight-hidden",{inputId:"input-gate-weight-hidden",label:"$W_{ih}$",min:-10,max:10,step:.1,value:.3,decimals:2,onChange:()=>this.render()}),this.inputGateBiasHiddenSlider=new ParamSlider("paramslider-input-gate-bias-hidden",{inputId:"input-gate-bias-hidden",label:"$b_{ih}$",min:-10,max:10,step:.1,value:0,decimals:2,onChange:()=>this.render()}),this.cellWeightInputSlider=new ParamSlider("paramslider-cell-weight-input",{inputId:"cell-weight-input",label:"$W_{cx}$",min:-10,max:10,step:.1,value:1,decimals:2,onChange:()=>this.render()}),this.cellBiasInputSlider=new ParamSlider("paramslider-cell-bias-input",{inputId:"cell-bias-input",label:"$b_{cx}$",min:-10,max:10,step:.1,value:0,decimals:2,onChange:()=>this.render()}),this.cellWeightHiddenSlider=new ParamSlider("paramslider-cell-weight-hidden",{inputId:"cell-weight-hidden",label:"$W_{ch}$",min:-10,max:10,step:.1,value:.2,decimals:2,onChange:()=>this.render()}),this.cellBiasHiddenSlider=new ParamSlider("paramslider-cell-bias-hidden",{inputId:"cell-bias-hidden",label:"$b_{ch}$",min:-10,max:10,step:.1,value:0,decimals:2,onChange:()=>this.render()}),this.outputGateWeightInputSlider=new ParamSlider("paramslider-output-gate-weight-input",{inputId:"output-gate-weight-input",label:"$W_{ox}$",min:-10,max:10,step:.1,value:.5,decimals:2,onChange:()=>this.render()}),this.outputGateBiasInputSlider=new ParamSlider("paramslider-output-gate-bias-input",{inputId:"output-gate-bias-input",label:"$b_{ox}$",min:-10,max:10,step:.1,value:0,decimals:2,onChange:()=>this.render()}),this.outputGateWeightHiddenSlider=new ParamSlider("paramslider-output-gate-weight-hidden",{inputId:"output-gate-weight-hidden",label:"$W_{oh}$",min:-10,max:10,step:.1,value:.4,decimals:2,onChange:()=>this.render()}),this.outputGateBiasHiddenSlider=new ParamSlider("paramslider-output-gate-bias-hidden",{inputId:"output-gate-bias-hidden",label:"$b_{oh}$",min:-10,max:10,step:.1,value:0,decimals:2,onChange:()=>this.render()})}configureCanvases(){const input=CanvasHelper.setupCanvas(this.inputCanvas,{ctx:this.inputCtx}),lstm=CanvasHelper.setupCanvas(this.lstmCanvas,{ctx:this.lstmCtx}),output=CanvasHelper.setupCanvas(this.outputCanvas,{ctx:this.outputCtx});this.inputCtx=input.ctx,this.lstmCtx=lstm.ctx,this.outputCtx=output.ctx}setupEventListeners(){const fancyPanels=document.querySelectorAll(".controls .fancybox-panel"),sequenceBoxes=fancyPanels[0]?fancyPanels[0].querySelectorAll(".fancybox"):[];sequenceBoxes.forEach(box=>{box.addEventListener("click",()=>{sequenceBoxes.forEach(b=>b.classList.remove("active")),box.classList.add("active"),this.selectedSequence=box.dataset.type,this.reset(),this.render()})});const scalingContainer=document.getElementById("input-scaling-container"),scalingBoxes=scalingContainer?scalingContainer.querySelectorAll(".fancybox"):[];scalingBoxes.forEach(box=>{box.addEventListener("click",()=>{scalingBoxes.forEach(b=>b.classList.remove("active")),box.classList.add("active"),this.useNormalization="normalized"===box.dataset.type,this.reset(),this.render()})}),this.stepBtn.addEventListener("click",()=>this.step()),this.resetBtn.addEventListener("click",()=>{this.reset(),this.render()}),this.optimiseBtn.addEventListener("click",()=>this.optimise())}reset(){this.currentTimestep=0,this.hiddenState=0,this.cellState=0,this.outputs=[],this.hiddenStates=[],this.cellStates=[],this.gateValues=[];const rawSequence=this.sequences[this.selectedSequence];this.currentSequence=this.useNormalization?this.normalizeSequence(rawSequence):rawSequence,this.resetHistoryTable()}normalizeSequence(sequence){const min=Math.min(...sequence),range=Math.max(...sequence)-min;return 0===range?sequence.map(()=>0):sequence.map(val=>{const normalized=2*(val-min)/range-1;return Math.round(100*normalized)/100})}resetHistoryTable(){const historyBody=document.getElementById("historyBody");historyBody&&(historyBody.innerHTML='\n            <tr class="history-row-step">\n                <th>Step</th>\n                <td class="current-iteration">-</td>\n            </tr>\n            <tr class="history-row-input">\n                <th>Input (x<sub>t</sub>)</th>\n                <td class="current-iteration">-</td>\n            </tr>\n            <tr class="history-row-expected">\n                <th>Expected Next</th>\n                <td class="current-iteration">-</td>\n            </tr>\n            <tr class="history-row-cell">\n                <th>Cell State (C<sub>t</sub>)</th>\n                <td class="current-iteration">-</td>\n            </tr>\n            <tr class="history-row-output">\n                <th>Hidden State (h<sub>t</sub>)</th>\n                <td class="current-iteration">-</td>\n            </tr>\n            <tr class="history-row-error">\n                <th>Error (Δ)</th>\n                <td class="current-iteration">-</td>\n            </tr>\n            <tr class="history-row-expected-delta">\n                <th>Expected Δ Output</th>\n                <td class="current-iteration">-</td>\n            </tr>\n            <tr class="history-row-actual-delta">\n                <th>Actual Δ Output</th>\n                <td class="current-iteration">-</td>\n            </tr>\n        ')}sigmoid(x){return 1/(1+Math.exp(-x))}step(){if(this.currentTimestep<this.currentSequence.length&&this.currentTimestep<10){const input=this.currentSequence[this.currentTimestep],wfx=this.forgetWeightInputSlider.value,bfx=this.forgetBiasInputSlider.value,wfh=this.forgetWeightHiddenSlider.value,bfh=this.forgetBiasHiddenSlider.value,wix=this.inputGateWeightInputSlider.value,bix=this.inputGateBiasInputSlider.value,wih=this.inputGateWeightHiddenSlider.value,bih=this.inputGateBiasHiddenSlider.value,wcx=this.cellWeightInputSlider.value,bcx=this.cellBiasInputSlider.value,wch=this.cellWeightHiddenSlider.value,bch=this.cellBiasHiddenSlider.value,wox=this.outputGateWeightInputSlider.value,box=this.outputGateBiasInputSlider.value,woh=this.outputGateWeightHiddenSlider.value,boh=this.outputGateBiasHiddenSlider.value,forgetGate=this.sigmoid(wfx*input+bfx+wfh*this.hiddenState+bfh),inputGate=this.sigmoid(wix*input+bix+wih*this.hiddenState+bih),inputNode=this.applyActivation(wcx*input+bcx+wch*this.hiddenState+bch),outputGate=this.sigmoid(wox*input+box+woh*this.hiddenState+boh);this.cellState=forgetGate*this.cellState+inputGate*inputNode,this.hiddenState=outputGate*Math.tanh(this.cellState);const output=this.hiddenState;this.outputs.push(output),this.hiddenStates.push(this.hiddenState),this.cellStates.push(this.cellState),this.gateValues.push({forget:forgetGate,input:inputGate,cell:inputNode,output:outputGate});const expectedNext=this.currentTimestep<this.currentSequence.length-1?this.currentSequence[this.currentTimestep+1]:null,error=null!==expectedNext?output-expectedNext:null,expectedDelta=this.currentTimestep<this.currentSequence.length-1?this.currentSequence[this.currentTimestep+1]-this.currentSequence[this.currentTimestep]:null,actualDelta=this.outputs.length>1?output-this.outputs[this.outputs.length-2]:null;this.addHistoryColumn(this.currentTimestep,input,expectedNext,this.cellState,output,error,expectedDelta,actualDelta),this.currentTimestep++,this.render()}}addHistoryColumn(step,input,expectedNext,cellState,hiddenState,error,expectedDelta,actualDelta){const rows=[document.querySelector(".history-row-step"),document.querySelector(".history-row-input"),document.querySelector(".history-row-expected"),document.querySelector(".history-row-cell"),document.querySelector(".history-row-output"),document.querySelector(".history-row-error"),document.querySelector(".history-row-expected-delta"),document.querySelector(".history-row-actual-delta")];if(!rows[0])return;const formatValue=val=>null==val?"-":"number"==typeof val?val.toFixed(2):val,currentIterationCells=document.querySelectorAll(".current-iteration");currentIterationCells.length>0&&"-"===currentIterationCells[0].textContent.trim()?(rows[0].querySelector(".current-iteration").textContent=step,rows[1].querySelector(".current-iteration").textContent=formatValue(input),rows[2].querySelector(".current-iteration").textContent=formatValue(expectedNext),rows[3].querySelector(".current-iteration").textContent=formatValue(cellState),rows[4].querySelector(".current-iteration").textContent=formatValue(hiddenState),rows[5].querySelector(".current-iteration").textContent=formatValue(error),rows[6].querySelector(".current-iteration").textContent=formatValue(expectedDelta),rows[7].querySelector(".current-iteration").textContent=formatValue(actualDelta)):(currentIterationCells.forEach(cell=>{cell.classList.remove("current-iteration")}),rows[0].insertAdjacentHTML("beforeend",`<td class="current-iteration">${step}</td>`),rows[1].insertAdjacentHTML("beforeend",`<td class="current-iteration">${formatValue(input)}</td>`),rows[2].insertAdjacentHTML("beforeend",`<td class="current-iteration">${formatValue(expectedNext)}</td>`),rows[3].insertAdjacentHTML("beforeend",`<td class="current-iteration">${formatValue(cellState)}</td>`),rows[4].insertAdjacentHTML("beforeend",`<td class="current-iteration">${formatValue(hiddenState)}</td>`),rows[5].insertAdjacentHTML("beforeend",`<td class="current-iteration">${formatValue(error)}</td>`),rows[6].insertAdjacentHTML("beforeend",`<td class="current-iteration">${formatValue(expectedDelta)}</td>`),rows[7].insertAdjacentHTML("beforeend",`<td class="current-iteration">${formatValue(actualDelta)}</td>`));const scrollContainer=document.getElementById("historyScroll");scrollContainer&&(scrollContainer.scrollLeft=scrollContainer.scrollWidth)}optimise(){let seed=42;const seededRandom=()=>(seed=(9301*seed+49297)%233280,seed/233280);let bestParams=null,bestLoss=1/0;for(let restart=0;restart<15;restart++){let params={wfx:6*seededRandom()-3,bfx:6*seededRandom()-3,wfh:6*seededRandom()-3,bfh:6*seededRandom()-3,wix:6*seededRandom()-3,bix:6*seededRandom()-3,wih:6*seededRandom()-3,bih:6*seededRandom()-3,wcx:6*seededRandom()-3,bcx:6*seededRandom()-3,wch:6*seededRandom()-3,bch:6*seededRandom()-3,wox:6*seededRandom()-3,box:6*seededRandom()-3,woh:6*seededRandom()-3,boh:6*seededRandom()-3};const learningRate=.1,momentum=.95,maxIterations=1e3,tolerance=1e-8;let velocity={wfx:0,bfx:0,wfh:0,bfh:0,wix:0,bix:0,wih:0,bih:0,wcx:0,bcx:0,wch:0,bch:0,wox:0,box:0,woh:0,boh:0},prevLoss=1/0;for(let iter=0;iter<maxIterations;iter++){const gradients=this.computeGradients(params);for(let key of["wfx","bfx","wfh","bfh","wix","bix","wih","bih","wcx","bcx","wch","bch","wox","box","woh","boh"])velocity[key]=momentum*velocity[key]-learningRate*gradients[key],params[key]+=velocity[key],params[key]=Math.max(-10,Math.min(10,params[key]));const currentLoss=this.computeLoss(params.wfx,params.bfx,params.wfh,params.bfh,params.wix,params.bix,params.wih,params.bih,params.wcx,params.bcx,params.wch,params.bch,params.wox,params.box,params.woh,params.boh);if(Math.abs(prevLoss-currentLoss)<tolerance)break;prevLoss=currentLoss}const finalLoss=this.computeLoss(params.wfx,params.bfx,params.wfh,params.bfh,params.wix,params.bix,params.wih,params.bih,params.wcx,params.bcx,params.wch,params.bch,params.wox,params.box,params.woh,params.boh);finalLoss<bestLoss&&(bestLoss=finalLoss,bestParams={...params})}this.forgetWeightInputSlider.setValue(Math.round(10*bestParams.wfx)/10),this.forgetBiasInputSlider.setValue(Math.round(10*bestParams.bfx)/10),this.forgetWeightHiddenSlider.setValue(Math.round(10*bestParams.wfh)/10),this.forgetBiasHiddenSlider.setValue(Math.round(10*bestParams.bfh)/10),this.inputGateWeightInputSlider.setValue(Math.round(10*bestParams.wix)/10),this.inputGateBiasInputSlider.setValue(Math.round(10*bestParams.bix)/10),this.inputGateWeightHiddenSlider.setValue(Math.round(10*bestParams.wih)/10),this.inputGateBiasHiddenSlider.setValue(Math.round(10*bestParams.bih)/10),this.cellWeightInputSlider.setValue(Math.round(10*bestParams.wcx)/10),this.cellBiasInputSlider.setValue(Math.round(10*bestParams.bcx)/10),this.cellWeightHiddenSlider.setValue(Math.round(10*bestParams.wch)/10),this.cellBiasHiddenSlider.setValue(Math.round(10*bestParams.bch)/10),this.outputGateWeightInputSlider.setValue(Math.round(10*bestParams.wox)/10),this.outputGateBiasInputSlider.setValue(Math.round(10*bestParams.box)/10),this.outputGateWeightHiddenSlider.setValue(Math.round(10*bestParams.woh)/10),this.outputGateBiasHiddenSlider.setValue(Math.round(10*bestParams.boh)/10),this.reset(),this.render()}computeGradients(params){const gradients={};for(let key of["wfx","bfx","wfh","bfh","wix","bix","wih","bih","wcx","bcx","wch","bch","wox","box","woh","boh"]){const originalValue=params[key];params[key]=originalValue+1e-4;const lossPlus=this.computeLoss(params.wfx,params.bfx,params.wfh,params.bfh,params.wix,params.bix,params.wih,params.bih,params.wcx,params.bcx,params.wch,params.bch,params.wox,params.box,params.woh,params.boh);params[key]=originalValue-1e-4;const lossMinus=this.computeLoss(params.wfx,params.bfx,params.wfh,params.bfh,params.wix,params.bix,params.wih,params.bih,params.wcx,params.bcx,params.wch,params.bch,params.wox,params.box,params.woh,params.boh);gradients[key]=(lossPlus-lossMinus)/2e-4,params[key]=originalValue}return gradients}computeLoss(wfx,bfx,wfh,bfh,wix,bix,wih,bih,wcx,bcx,wch,bch,wox,box,woh,boh){let hiddenState=0,cellState=0,totalError=0,count=0;for(let t=0;t<this.currentSequence.length-1;t++){const input=this.currentSequence[t],target=this.currentSequence[t+1];cellState=this.sigmoid(wfx*input+bfx+wfh*hiddenState+bfh)*cellState+this.sigmoid(wix*input+bix+wih*hiddenState+bih)*this.applyActivation(wcx*input+bcx+wch*hiddenState+bch),hiddenState=this.sigmoid(wox*input+box+woh*hiddenState+boh)*Math.tanh(cellState);const error=hiddenState-target;totalError+=error*error,count++}return count>0?totalError/count:1/0}applyActivation(x){return Math.tanh(x)}render(){this.clearCanvases(),this.drawInputSequence(),this.drawLSTMCell(),this.drawOutput()}clearCanvases(){const canvases=[this.inputCanvas,this.lstmCanvas,this.outputCanvas];[this.inputCtx,this.lstmCtx,this.outputCtx].forEach((ctx,i)=>{ctx.clearRect(0,0,canvases[i].clientWidth,canvases[i].clientHeight)})}drawInputSequence(){const ctx=this.inputCtx,canvas=this.inputCanvas,width=canvas.clientWidth,height=canvas.clientHeight,sequence=this.currentSequence,cellWidth=width/sequence.length,startY=(height-60)/2;if(sequence.forEach((value,index)=>{const x=index*cellWidth+.1*cellWidth,y=startY,w=.8*cellWidth;index===this.currentTimestep&&this.currentTimestep<sequence.length?(ctx.fillStyle="#ffd700",ctx.strokeStyle="#ff8c00",ctx.lineWidth=3):index<this.currentTimestep?(ctx.fillStyle="#e3f2fd",ctx.strokeStyle="#1976d2",ctx.lineWidth=2):(ctx.fillStyle="#f5f5f5",ctx.strokeStyle="#ccc",ctx.lineWidth=1),ctx.fillRect(x,y,w,60),ctx.strokeRect(x,y,w,60),ctx.fillStyle="#333",ctx.font="18px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText(value.toString(),x+w/2,y+30),ctx.font="12px Arial",ctx.fillStyle="#666",ctx.fillText(`t=${index}`,x+w/2,y+60+15)}),this.currentTimestep<sequence.length){const arrowX=this.currentTimestep*cellWidth+cellWidth/2,arrowY=startY-20;ctx.fillStyle="#ff6b6b",ctx.beginPath(),ctx.moveTo(arrowX,arrowY),ctx.lineTo(arrowX-8,arrowY-15),ctx.lineTo(arrowX+8,arrowY-15),ctx.closePath(),ctx.fill()}}drawLSTMCell(){const ctx=this.lstmCtx,canvas=this.lstmCanvas,width=canvas.clientWidth,centerX=width/2,centerY=canvas.clientHeight/2+25,cellStateY=centerY-70,cellRectY=cellStateY-40,cellRectWidth=width-190,gateY=centerY+40,forgetGateX=95+1*cellRectWidth/5,inputGateX=95+2*cellRectWidth/5,inputNodeX=95+3*cellRectWidth/5,outputGateX=95+4*cellRectWidth/5;ctx.fillStyle="#f3e5f5",ctx.strokeStyle="#7b1fa2",ctx.lineWidth=3,ctx.beginPath(),ctx.roundRect(95,cellRectY,cellRectWidth,210,10),ctx.fill(),ctx.stroke(),ctx.fillStyle="#7b1fa2",ctx.font="bold 16px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("LSTM Cell",centerX,cellRectY+15);const inputX=(60+forgetGateX)/2,inputY=centerY+140;if(this.drawCircleNode(ctx,inputX,inputY,20,"#e3f2fd","#1976d2"),ctx.fillStyle="#333",ctx.font="bold 14px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("x",inputX-5,inputY),ctx.font="10px Arial",ctx.fillText("t",inputX+5,inputY+5),this.currentTimestep>0&&this.currentTimestep<=this.currentSequence.length){const currentInput=this.currentSequence[this.currentTimestep-1];ctx.font="11px Arial",ctx.fillStyle="#1976d2",ctx.fillText(currentInput.toString(),inputX,inputY+28)}const prevCellY=cellStateY,prevCell=this.cellStates.length>1?this.cellStates[this.cellStates.length-2]:0;this.drawCircleNode(ctx,60,prevCellY,18,"#fce4ec","#c2185b"),ctx.fillStyle="#333",ctx.font="bold 14px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("c",54,prevCellY),ctx.font="9px Arial",ctx.fillText("t-1",66,prevCellY+6),ctx.font="10px Arial",ctx.fillStyle="#c2185b",ctx.fillText(prevCell.toFixed(2),60,prevCellY+25);const prevHiddenY=centerY+80,prevHidden=this.hiddenStates.length>1?this.hiddenStates[this.hiddenStates.length-2]:0;this.drawCircleNode(ctx,60,prevHiddenY,18,"#c8e6c9","#1b5e20"),ctx.fillStyle="#333",ctx.font="bold 14px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("h",54,prevHiddenY),ctx.font="9px Arial",ctx.fillText("t-1",66,prevHiddenY+6),ctx.font="10px Arial",ctx.fillStyle="#1b5e20",ctx.fillText(prevHidden.toFixed(2),60,prevHiddenY+25);const outputHiddenX=(outputGateX+(width-60))/2,outputHiddenY=cellStateY-(inputY-(centerY+80))-10;this.drawCircleNode(ctx,outputHiddenX,outputHiddenY,18,"#c8e6c9","#2e7d32"),ctx.fillStyle="#333",ctx.font="bold 14px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("h",outputHiddenX-5,outputHiddenY),ctx.font="10px Arial",ctx.fillText("t",outputHiddenX+5,outputHiddenY+5),ctx.font="10px Arial",ctx.fillStyle="#2e7d32",ctx.fillText(this.hiddenState.toFixed(2),outputHiddenX,outputHiddenY-25);const currCellX=width-60,currCellY=cellStateY;this.drawCircleNode(ctx,currCellX,currCellY,18,"#fce4ec","#c2185b"),ctx.fillStyle="#333",ctx.font="bold 14px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("c",currCellX-5,currCellY),ctx.font="10px Arial",ctx.fillText("t",currCellX+5,currCellY+5),ctx.font="10px Arial",ctx.fillStyle="#c2185b",ctx.fillText(this.cellState.toFixed(2),currCellX,currCellY+25);const currHiddenX=width-60,currHiddenY=centerY+80;this.drawCircleNode(ctx,currHiddenX,currHiddenY,18,"#e8f5e8","#388e3c"),ctx.fillStyle="#333",ctx.font="bold 14px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("h",currHiddenX-5,currHiddenY),ctx.font="10px Arial",ctx.fillText("t",currHiddenX+5,currHiddenY+5),ctx.font="10px Arial",ctx.fillStyle="#388e3c",ctx.fillText(this.hiddenState.toFixed(2),currHiddenX,currHiddenY+25),ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(78,prevHiddenY),ctx.lineTo(outputGateX,prevHiddenY),ctx.stroke(),ctx.beginPath(),ctx.moveTo(inputX,inputY-20),ctx.lineTo(inputX,prevHiddenY),ctx.stroke();const gateBottomY=gateY+15;ctx.strokeStyle="#333",ctx.lineWidth=1,[forgetGateX,inputGateX,inputNodeX,outputGateX].forEach(gateX=>{ctx.beginPath(),ctx.moveTo(gateX,prevHiddenY),ctx.lineTo(gateX,gateBottomY),ctx.stroke(),this.drawArrow(ctx,gateX,prevHiddenY,gateX,gateBottomY,"#333")});const gates=this.gateValues.length>0?this.gateValues[this.gateValues.length-1]:null;this.drawGate(ctx,forgetGateX,gateY,50,30,"σ","#00bcd4",gates?gates.forget.toFixed(2):"-","W_f"),this.drawGate(ctx,inputGateX,gateY,50,30,"σ","#00bcd4",gates?gates.input.toFixed(2):"-","W_i"),this.drawGate(ctx,inputNodeX,gateY,50,30,this.getActivationSymbol(),"#00bcd4",gates?gates.cell.toFixed(2):"-","W_c"),this.drawGate(ctx,outputGateX,gateY,50,30,"σ","#00bcd4",gates?gates.output.toFixed(2):"-","W_o");const gateTopY=gateY-15,multiplyBottomY=prevCellY+12;ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(forgetGateX,gateTopY),ctx.lineTo(forgetGateX,multiplyBottomY),ctx.stroke(),this.drawArrow(ctx,forgetGateX,gateTopY,forgetGateX,multiplyBottomY,"#333"),ctx.fillStyle="#ffffff",ctx.strokeStyle="#ff9800",ctx.lineWidth=2,ctx.beginPath(),ctx.arc(forgetGateX,prevCellY,12,0,2*Math.PI),ctx.fill(),ctx.stroke(),ctx.fillStyle="#ff9800",ctx.font="bold 18px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("×",forgetGateX,prevCellY),ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(78,prevCellY),ctx.lineTo(forgetGateX-12,prevCellY),ctx.stroke(),this.drawArrow(ctx,78,prevCellY,forgetGateX-12,prevCellY,"#333"),ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(forgetGateX+12,prevCellY),ctx.lineTo(inputNodeX-12,prevCellY),ctx.stroke(),this.drawArrow(ctx,forgetGateX+12,prevCellY,inputNodeX-12,prevCellY,"#333"),ctx.fillStyle="#ffffff",ctx.strokeStyle="#ff9800",ctx.lineWidth=2,ctx.beginPath(),ctx.arc(inputNodeX,prevCellY,12,0,2*Math.PI),ctx.fill(),ctx.stroke(),ctx.fillStyle="#ff9800",ctx.font="bold 18px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("+",inputNodeX,prevCellY),ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(inputNodeX+12,prevCellY),ctx.lineTo(currCellX-18,currCellY),ctx.stroke(),this.drawArrow(ctx,inputNodeX+12,prevCellY,currCellX-18,currCellY,"#333");const multiplyY=(prevCellY+gateY)/2,wcTopY=gateY-15,multiplyCellBottomY=multiplyY+12;ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(inputNodeX,wcTopY),ctx.lineTo(inputNodeX,multiplyCellBottomY),ctx.stroke(),this.drawArrow(ctx,inputNodeX,wcTopY,inputNodeX,multiplyCellBottomY,"#333"),ctx.fillStyle="#ffffff",ctx.strokeStyle="#ff9800",ctx.lineWidth=2,ctx.beginPath(),ctx.arc(inputNodeX,multiplyY,12,0,2*Math.PI),ctx.fill(),ctx.stroke(),ctx.fillStyle="#ff9800",ctx.font="bold 18px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("×",inputNodeX,multiplyY);const multiplyTopY=multiplyY-12,plusBottomY=prevCellY+12;ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(inputNodeX,multiplyTopY),ctx.lineTo(inputNodeX,plusBottomY),ctx.stroke(),this.drawArrow(ctx,inputNodeX,multiplyTopY,inputNodeX,plusBottomY,"#333");const wiTopY=gateY-15,multiplyLeftX=inputNodeX-12;ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(inputGateX,wiTopY),ctx.lineTo(inputGateX,multiplyY),ctx.stroke(),ctx.beginPath(),ctx.moveTo(inputGateX,multiplyY),ctx.lineTo(multiplyLeftX,multiplyY),ctx.stroke(),this.drawArrow(ctx,inputGateX,multiplyY,multiplyLeftX,multiplyY,"#333");const tanhX=(outputGateX+outputHiddenX)/2,tanhY=(prevCellY+multiplyY)/2,tanhTopY=tanhY-15;ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(tanhX,prevCellY),ctx.lineTo(tanhX,tanhTopY),ctx.stroke(),this.drawArrow(ctx,tanhX,prevCellY,tanhX,tanhTopY,"#333"),ctx.fillStyle="#ff980040",ctx.strokeStyle="#ff9800",ctx.lineWidth=2,ctx.beginPath(),ctx.roundRect(tanhX-25,tanhY-15,50,30,5),ctx.fill(),ctx.stroke(),ctx.fillStyle="#333",ctx.font="bold 14px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("tanh",tanhX,tanhY-3);const multiplyTanhY=(tanhY+gateY)/2,tanhBottomY=tanhY+15,multiplyTanhTopY=multiplyTanhY-12;ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(tanhX,tanhBottomY),ctx.lineTo(tanhX,multiplyTanhTopY),ctx.stroke(),this.drawArrow(ctx,tanhX,tanhBottomY,tanhX,multiplyTanhTopY,"#333");const woTopY=gateY-15,multiplyTanhLeftX=tanhX-12;ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(outputGateX,woTopY),ctx.lineTo(outputGateX,multiplyTanhY),ctx.stroke(),ctx.beginPath(),ctx.moveTo(outputGateX,multiplyTanhY),ctx.lineTo(multiplyTanhLeftX,multiplyTanhY),ctx.stroke(),this.drawArrow(ctx,outputGateX,multiplyTanhY,multiplyTanhLeftX,multiplyTanhY,"#333"),ctx.fillStyle="#ffffff",ctx.strokeStyle="#ff9800",ctx.lineWidth=2,ctx.beginPath(),ctx.arc(tanhX,multiplyTanhY,12,0,2*Math.PI),ctx.fill(),ctx.stroke(),ctx.fillStyle="#ff9800",ctx.font="bold 18px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("×",tanhX,multiplyTanhY);const multiplyTanhBottomY=multiplyTanhY+12;ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(tanhX,multiplyTanhBottomY),ctx.lineTo(tanhX,currHiddenY),ctx.stroke(),ctx.beginPath(),ctx.moveTo(tanhX,currHiddenY),ctx.lineTo(currHiddenX-18,currHiddenY),ctx.stroke(),this.drawArrow(ctx,tanhX,currHiddenY,currHiddenX-18,currHiddenY,"#333");const outputHiddenBottomY=outputHiddenY+18;ctx.strokeStyle="#333",ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(outputHiddenX,currHiddenY),ctx.lineTo(outputHiddenX,outputHiddenBottomY),ctx.stroke(),this.drawArrow(ctx,outputHiddenX,currHiddenY,outputHiddenX,outputHiddenBottomY,"#333")}getActivationSymbol(){return"tanh"}drawCircleNode(ctx,x,y,radius,fillColor,strokeColor){ctx.fillStyle=fillColor,ctx.strokeStyle=strokeColor,ctx.lineWidth=2,ctx.beginPath(),ctx.arc(x,y,radius,0,2*Math.PI),ctx.fill(),ctx.stroke()}drawGate(ctx,x,y,width,height,symbol,color,value,weight){ctx.fillStyle=color+"40",ctx.strokeStyle=color,ctx.lineWidth=2,ctx.beginPath(),ctx.roundRect(x-width/2,y-height/2,width,height,5),ctx.fill(),ctx.stroke(),ctx.fillStyle="#333",ctx.font="bold 14px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText(symbol,x,y-3),ctx.font="10px Arial",ctx.fillStyle="#333",ctx.textAlign="left",ctx.fillText(value,x-width/2+3,y-height/2-8),ctx.font="bold 10px Arial",ctx.fillStyle=color,ctx.textAlign="left",ctx.fillText(weight,x-width/2+3,y+height/2+10),ctx.textAlign="center"}drawOperation(ctx,x,y,size,symbol,color){ctx.fillStyle="#ffffff",ctx.strokeStyle=color,ctx.lineWidth=2,ctx.beginPath(),ctx.arc(x,y,size/2,0,2*Math.PI),ctx.fill(),ctx.stroke(),ctx.fillStyle="#333",ctx.font="bold 12px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText(symbol,x,y)}drawVerticalLine(ctx,x,y1,y2,color,lineWidth){ctx.strokeStyle=color,ctx.lineWidth=lineWidth,ctx.beginPath(),ctx.moveTo(x,y1),ctx.lineTo(x,y2),ctx.stroke(),this.drawArrow(ctx,x,y2-10,x,y2,color)}drawArrow(ctx,x1,y1,x2,y2,color){const angle=Math.atan2(y2-y1,x2-x1);ctx.fillStyle=color,ctx.beginPath(),ctx.moveTo(x2,y2),ctx.lineTo(x2-6*Math.cos(angle-Math.PI/6),y2-6*Math.sin(angle-Math.PI/6)),ctx.lineTo(x2-6*Math.cos(angle+Math.PI/6),y2-6*Math.sin(angle+Math.PI/6)),ctx.closePath(),ctx.fill()}drawConnection(ctx,x1,y1,x2,y2,label,color){ctx.strokeStyle=color,ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(x1,y1),ctx.lineTo(x2,y2),ctx.stroke();const angle=Math.atan2(y2-y1,x2-x1);if(ctx.beginPath(),ctx.moveTo(x2,y2),ctx.lineTo(x2-8*Math.cos(angle-Math.PI/6),y2-8*Math.sin(angle-Math.PI/6)),ctx.lineTo(x2-8*Math.cos(angle+Math.PI/6),y2-8*Math.sin(angle+Math.PI/6)),ctx.closePath(),ctx.fillStyle=color,ctx.fill(),label){const labelX=(x1+x2)/2,labelY=(y1+y2)/2-5;ctx.fillStyle=color,ctx.font="12px Arial",ctx.textAlign="center",ctx.fillText(label,labelX,labelY)}}drawOutput(){const ctx=this.outputCtx,canvas=this.outputCanvas,width=canvas.clientWidth||canvas.width,height=canvas.clientHeight||canvas.height;if(!this.currentSequence||0===this.currentSequence.length)return;const cellWidth=width/this.currentSequence.length,startY=(height-60)/2;this.outputs.forEach((output,index)=>{const x=index*cellWidth+.1*cellWidth,y=startY,w=.8*cellWidth;ctx.fillStyle="#e8f5e8",ctx.strokeStyle="#388e3c",ctx.lineWidth=2,ctx.fillRect(x,y,w,60),ctx.strokeRect(x,y,w,60),ctx.fillStyle="#333",ctx.font="18px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText(output.toFixed(2),x+w/2,y+30),ctx.font="12px Arial",ctx.fillStyle="#666",ctx.fillText(`t=${index}`,x+w/2,y+60+15)});for(let index=this.outputs.length;index<this.currentSequence.length;index++){const x=index*cellWidth+.1*cellWidth,y=startY,w=.8*cellWidth,h=60;ctx.fillStyle="#f5f5f5",ctx.strokeStyle="#ccc",ctx.lineWidth=1,ctx.fillRect(x,y,w,h),ctx.strokeRect(x,y,w,h),ctx.font="12px Arial",ctx.fillStyle="#666",ctx.textAlign="center",ctx.fillText(`t=${index}`,x+w/2,y+h+15)}}}