const CELL_SIZE=80,GRID_PADDING=10,EMPTY=0,OBSTACLE=1,START=2,GOAL=3,AGENT=4,PATH=5,REWARD_SMALL=6,REWARD_MEDIUM=7,REWARD_LARGE=8;let currentMode="normal";const MODE_CONFIG={normal:{gridSize:5,grid:[[0,0,1,0,3],[0,0,0,0,0],[0,0,1,1,1],[0,0,0,0,0],[2,1,0,0,0]],startRow:4,startCol:0,fogOfWar:!1},fogofwar:{gridSize:5,grid:[[0,0,1,0,3],[0,0,0,0,0],[0,0,1,1,1],[0,0,0,0,0],[2,1,0,0,0]],startRow:4,startCol:0,fogOfWar:!0},competition:{gridSize:6,grid:[[3,1,0,7,0,0],[0,0,0,1,0,0],[0,1,0,0,0,0],[1,6,1,1,0,0],[1,0,0,1,1,0],[2,0,0,0,0,0]],startRow:5,startCol:0,fogOfWar:!0}};let canvas,ctx,gameState={agentRow:4,agentCol:0,steps:0,totalReward:0,gameOver:!1,visitedCells:new Set,exploredCells:new Set,currentAttempt:1,maxAttempts:3,totalScore:0,attempt1Trajectory:[],attempt1Values:new Map,attempt1Visited:new Set,attempt2Visited:new Set},competitionMode=!1,competitionCompleted=!1,competitionUsername=null,leaderboard=null;const COLORS={empty:"#ffffff",obstacle:"#000000",start:"#28a745",goal:"#ffc107",reward:"#90EE90",agent:"#007bff",path:"#e3f2fd",grid:"#dee2e6",text:"#343a40",fog:"#d3d3d3",fogText:"#95a5a6",rewardPositive:"#28a745",rewardNegative:"#dc3545",obstacleText:"#ffffff"};function init(){canvas=document.getElementById("gridCanvas"),ctx=canvas.getContext("2d"),setupDemoTabs(),initializeLeaderboard(),updateModeUI(),initializeMode("normal"),document.addEventListener("keydown",handleKeyboard)}function setupDemoTabs(){const tabButtons=document.querySelectorAll(".demo-tab-button");tabButtons.forEach(button=>{button.addEventListener("click",()=>{const tabName=button.dataset.tab;tabButtons.forEach(btn=>btn.classList.remove("active")),button.classList.add("active"),currentMode=tabName,updateModeUI(),initializeMode(currentMode)})})}function updateModeUI(){const title=document.getElementById("mode-title"),subtitle=document.getElementById("mode-subtitle"),statsNormal=document.getElementById("stats-normal"),statsCompetition=document.getElementById("stats-competition"),resetButton=document.querySelector(".reset-button"),coordDisplay=document.getElementById("coordinate-display"),competitionInstructions=document.getElementById("competition-instructions");"normal"===currentMode?(title.textContent="Navigate to the Goal",subtitle.style.display="none",statsNormal.style.display="flex",statsCompetition.style.display="none",resetButton.style.display="inline-block",resetButton.textContent="Reset",coordDisplay.style.display="none",competitionInstructions.style.display="none"):"fogofwar"===currentMode?(title.textContent="Navigate with Limited Visibility",subtitle.textContent="Same map as Normal mode - only adjacent cells are visible, simulating what an RL agent sees",subtitle.style.display="block",statsNormal.style.display="flex",statsCompetition.style.display="none",resetButton.style.display="inline-block",resetButton.textContent="Reset",coordDisplay.style.display="block",competitionInstructions.style.display="none"):"competition"===currentMode&&(title.textContent="Three-Attempt Competition",subtitle.textContent="Larger 6Ã—6 grid - the goal has moved to a new location!",subtitle.style.display="block",statsNormal.style.display="none",statsCompetition.style.display="flex",resetButton.style.display="none",coordDisplay.style.display="block",competitionInstructions.style.display="block")}function initializeMode(mode){const config=MODE_CONFIG[mode];setupCanvas(config.gridSize),gameState.agentRow=config.startRow,gameState.agentCol=config.startCol,gameState.steps=0,gameState.totalReward=0,gameState.gameOver=!1,gameState.visitedCells=new Set,gameState.exploredCells=new Set,"competition"===mode&&(gameState.currentAttempt=1,gameState.totalScore=0,gameState.attempt1Trajectory=[],gameState.attempt1Values=new Map,gameState.attempt1Visited=new Set,gameState.attempt2Visited=new Set),gameState.visitedCells.add(`${gameState.agentRow},${gameState.agentCol}`),gameState.exploredCells.add(`${gameState.agentRow},${gameState.agentCol}`),config.fogOfWar&&addAdjacentToExplored(gameState.agentRow,gameState.agentCol),render(),updateStats()}function setupCanvas(gridSize){const dpr=window.devicePixelRatio||1,displaySize=80*gridSize+10*(gridSize+1);canvas.width=displaySize*dpr,canvas.height=displaySize*dpr,canvas.style.width=displaySize+"px",canvas.style.height=displaySize+"px",ctx.scale(dpr,dpr)}function handleKeyboard(e){if(gameState.gameOver)return;const key=e.key;"ArrowUp"===key?(e.preventDefault(),moveAgent("up")):"ArrowDown"===key?(e.preventDefault(),moveAgent("down")):"ArrowLeft"===key?(e.preventDefault(),moveAgent("left")):"ArrowRight"===key&&(e.preventDefault(),moveAgent("right"))}function moveAgent(direction){if(gameState.gameOver)return;const config=MODE_CONFIG[currentMode];let newRow=gameState.agentRow,newCol=gameState.agentCol;switch(direction){case"up":newRow=gameState.agentRow-1;break;case"down":newRow=gameState.agentRow+1;break;case"left":newCol=gameState.agentCol-1;break;case"right":newCol=gameState.agentCol+1}if(isValidMove(newRow,newCol,config)){gameState.agentRow=newRow,gameState.agentCol=newCol,gameState.visitedCells.add(`${gameState.agentRow},${gameState.agentCol}`),gameState.exploredCells.add(`${gameState.agentRow},${gameState.agentCol}`),config.fogOfWar&&addAdjacentToExplored(gameState.agentRow,gameState.agentCol),gameState.steps++;let stepReward=-1;gameState.totalReward+=stepReward,"competition"===currentMode&&1===gameState.currentAttempt&&gameState.attempt1Trajectory.push({row:gameState.agentRow,col:gameState.agentCol,reward:stepReward});const cellValue=config.grid[gameState.agentRow][gameState.agentCol];if(6===cellValue?(gameState.totalReward+=1,"competition"===currentMode&&1===gameState.currentAttempt&&(gameState.attempt1Trajectory[gameState.attempt1Trajectory.length-1].reward+=1)):7===cellValue?(gameState.totalReward+=2,"competition"===currentMode&&1===gameState.currentAttempt&&(gameState.attempt1Trajectory[gameState.attempt1Trajectory.length-1].reward+=2)):8===cellValue&&(gameState.totalReward+=7,"competition"===currentMode&&1===gameState.currentAttempt&&(gameState.attempt1Trajectory[gameState.attempt1Trajectory.length-1].reward+=7)),3===cellValue){const goalReward="competition"===currentMode?20:10;gameState.totalReward+=goalReward,gameState.gameOver=!0,"competition"===currentMode&&1===gameState.currentAttempt&&(gameState.attempt1Trajectory[gameState.attempt1Trajectory.length-1].reward+=goalReward),"competition"===currentMode?(gameState.totalScore+=gameState.totalReward,1===gameState.currentAttempt?(gameState.attempt1Visited=new Set(gameState.visitedCells),calculateValueEstimates(),document.getElementById("next-attempt-btn").style.display="block",document.getElementById("next-attempt-btn").textContent="Start Attempt 2",updateStatus("Attempt 1 Complete!"),competitionMode&&setTimeout(()=>{submitCompetitionScore(!1)},500)):2===gameState.currentAttempt?(gameState.attempt2Visited=new Set(gameState.visitedCells),document.getElementById("next-attempt-btn").style.display="block",document.getElementById("next-attempt-btn").textContent="Start Attempt 3",updateStatus("Attempt 2 Complete!"),competitionMode&&setTimeout(()=>{submitCompetitionScore(!1)},500)):(updateStatus("Competition Complete!"),competitionMode&&!competitionCompleted&&setTimeout(()=>{submitCompetitionScore(!0)},500))):updateStatus("Goal Reached!")}render(),updateStats()}}function addAdjacentToExplored(row,col){const config=MODE_CONFIG[currentMode];[[-1,0],[1,0],[0,-1],[0,1]].forEach(([dr,dc])=>{const newRow=row+dr,newCol=col+dc;newRow>=0&&newRow<config.gridSize&&newCol>=0&&newCol<config.gridSize&&gameState.exploredCells.add(`${newRow},${newCol}`)})}function calculateValueEstimates(){const trajectory=gameState.attempt1Trajectory;let cumulativeReward=0;for(let i=trajectory.length-1;i>=0;i--){const step=trajectory[i];cumulativeReward+=step.reward;const cellKey=`${step.row},${step.col}`;gameState.attempt1Values.has(cellKey)||gameState.attempt1Values.set(cellKey,cumulativeReward)}}function isValidMove(row,col,config){return!(row<0||row>=config.gridSize||col<0||col>=config.gridSize)&&1!==config.grid[row][col]}function isCellVisible(row,col){return!MODE_CONFIG[currentMode].fogOfWar||gameState.exploredCells.has(`${row},${col}`)}function render(){const config=MODE_CONFIG[currentMode],gridSize=config.gridSize;ctx.fillStyle="#f8f9fa",ctx.fillRect(0,0,canvas.width,canvas.height),"fogofwar"!==currentMode&&"competition"!==currentMode||updateCoordinateDisplay();for(let row=0;row<gridSize;row++)for(let col=0;col<gridSize;col++){if("fogofwar"===currentMode||"competition"===currentMode){const isCurrentCell=row===gameState.agentRow&&col===gameState.agentCol,isAdjacent=Math.abs(row-gameState.agentRow)+Math.abs(col-gameState.agentCol)===1;if(!isCurrentCell&&!isAdjacent)continue}const x=90*col+10,y=90*row+10,isVisible=isCellVisible(row,col);let fillColor=COLORS.empty;if(isVisible?(!gameState.visitedCells.has(`${row},${col}`)||3===config.grid[row][col]||6===config.grid[row][col]||7===config.grid[row][col]||8===config.grid[row][col]||row===gameState.agentRow&&col===gameState.agentCol||(fillColor=COLORS.path),1===config.grid[row][col]?fillColor=COLORS.obstacle:3===config.grid[row][col]?fillColor=COLORS.goal:6!==config.grid[row][col]&&7!==config.grid[row][col]&&8!==config.grid[row][col]||(fillColor=COLORS.reward),row===gameState.agentRow&&col===gameState.agentCol&&(fillColor=COLORS.agent)):fillColor=COLORS.fog,ctx.fillStyle=fillColor,ctx.fillRect(x,y,80,80),ctx.strokeStyle=COLORS.grid,ctx.lineWidth=2,ctx.strokeRect(x,y,80,80),isVisible)if(ctx.textAlign="center",ctx.textBaseline="middle","competition"!==currentMode||2!==gameState.currentAttempt||!gameState.attempt1Visited.has(`${row},${col}`)||row===gameState.agentRow&&col===gameState.agentCol)3!==config.grid[row][col]||row===gameState.agentRow&&col===gameState.agentCol?6!==config.grid[row][col]||row===gameState.agentRow&&col===gameState.agentCol?7!==config.grid[row][col]||row===gameState.agentRow&&col===gameState.agentCol?8!==config.grid[row][col]||row===gameState.agentRow&&col===gameState.agentCol?row!==config.startRow||col!==config.startCol||row===gameState.agentRow&&col===gameState.agentCol?row===gameState.agentRow&&col===gameState.agentCol&&(ctx.fillStyle="#ffffff",ctx.font="bold 24px monospace",ctx.fillText("A",x+40,y+40)):(ctx.fillStyle=COLORS.text,ctx.font="bold 12px monospace",ctx.fillText("START",x+40,y+40)):(ctx.fillStyle=COLORS.text,ctx.font="bold 18px monospace",ctx.fillText("+7",x+40,y+40)):(ctx.fillStyle=COLORS.text,ctx.font="bold 18px monospace",ctx.fillText("+2",x+40,y+40)):(ctx.fillStyle=COLORS.text,ctx.font="bold 18px monospace",ctx.fillText("+1",x+40,y+40)):(ctx.fillStyle=COLORS.text,ctx.font="bold 14px monospace",ctx.fillText("GOAL",x+40,y+40));else{const value=gameState.attempt1Values.get(`${row},${col}`);void 0!==value&&(ctx.font="bold 16px monospace",ctx.fillStyle=value>=0?COLORS.rewardPositive:COLORS.rewardNegative,ctx.fillText(value>0?`+${value}`:`${value}`,x+40,y+40))}}}function updateCoordinateDisplay(){const config=MODE_CONFIG[currentMode],coordDisplay=document.getElementById("coordinate-display");if(coordDisplay){const x=gameState.agentCol,y=config.gridSize-1-gameState.agentRow;coordDisplay.textContent=`Position: (${x}, ${y})`}}function updateStats(){if("competition"===currentMode){const attemptEl=document.getElementById("attempt-count"),stepsEl=document.getElementById("steps-count-comp"),currentRewardEl=document.getElementById("current-reward"),totalScoreEl=document.getElementById("total-score"),statusEl=document.getElementById("status-comp");attemptEl&&(attemptEl.textContent=`${gameState.currentAttempt} / ${gameState.maxAttempts}`),stepsEl&&(stepsEl.textContent=gameState.steps),currentRewardEl&&(currentRewardEl.textContent=gameState.totalReward),totalScoreEl&&(totalScoreEl.textContent=gameState.totalScore),!gameState.gameOver&&statusEl&&(statusEl.textContent="In Progress",statusEl.style.color="#007bff")}else{const stepsEl=document.getElementById("steps-count"),totalRewardEl=document.getElementById("total-reward"),statusEl=document.getElementById("status");stepsEl&&(stepsEl.textContent=gameState.steps),totalRewardEl&&(totalRewardEl.textContent=gameState.totalReward),!gameState.gameOver&&statusEl&&(statusEl.textContent="In Progress",statusEl.style.color="#007bff")}}function updateStatus(message){const statusEl="competition"===currentMode?document.getElementById("status-comp"):document.getElementById("status");statusEl&&(statusEl.textContent=message,statusEl.style.color="#28a745")}function resetEnvironment(){initializeMode(currentMode),"competition"===currentMode&&(document.getElementById("next-attempt-btn").style.display="none")}function startNextAttempt(){if("competition"!==currentMode)return;if(gameState.currentAttempt>=gameState.maxAttempts)return;const config=MODE_CONFIG[currentMode];gameState.currentAttempt++,gameState.agentRow=config.startRow,gameState.agentCol=config.startCol,gameState.steps=0,gameState.totalReward=0,gameState.gameOver=!1,gameState.visitedCells=new Set,gameState.exploredCells=new Set,gameState.visitedCells.add(`${gameState.agentRow},${gameState.agentCol}`),2===gameState.currentAttempt?gameState.attempt1Visited.forEach(cellKey=>{gameState.exploredCells.add(cellKey)}):gameState.currentAttempt,addAdjacentToExplored(gameState.agentRow,gameState.agentCol),document.getElementById("next-attempt-btn").style.display="none",render(),updateStats();const statusEl=document.getElementById("status-comp");statusEl&&(statusEl.textContent="Ready",statusEl.style.color="#343a40")}function toggleInstructions(event){event.preventDefault();const content=document.getElementById("instructions-content"),toggle=document.getElementById("toggle-instructions");content.classList.contains("collapsed")?(content.classList.remove("collapsed"),toggle.textContent="Hide Instructions"):(content.classList.add("collapsed"),toggle.textContent="Show Instructions")}function initializeLeaderboard(){"undefined"!=typeof LeaderboardClient?leaderboard=new LeaderboardClient({roomId:"lec08b_grid-world",autoConnect:!1,debug:!0,scoreFormat:["total_score"],scoreLabels:{total_score:"Total Score"},roomConfig:{display:"Grid World Navigation Challenge",metrics:["total_score"],sortBy:"total_score",order:"desc",description:"3-attempt navigation with fog of war - highest total score wins",maxUsers:200,sessionTimeout:18e5},onConnect:()=>{competitionMode&&(document.getElementById("leaderboard-panel").style.display="block")},onDisconnect:()=>{leaderboard&&leaderboard.updateStatus("Disconnected","disconnected")},onLeaderboardUpdate:data=>{leaderboard&&(leaderboard.updateLeaderboard(data),leaderboard.updateUserPositionFromLeaderboard(data))},onPositionUpdate:position=>{leaderboard&&leaderboard.updateUserPosition(position)},onError:error=>{leaderboard&&leaderboard.updateStatus("Connection error","disconnected")},onStatusChange:status=>{if("error"===status)leaderboard&&leaderboard.updateStatus("Server unavailable","disconnected");else if("joined"===status){const statusElement=document.getElementById("status-text");if(statusElement&&statusElement.textContent.includes("DEBUG / LOCAL TESTING")){const statusDot=document.getElementById("status-dot");statusDot&&(statusDot.className="status-indicator connected")}else leaderboard&&leaderboard.updateStatus("Competition active","connected")}},onUsernameAssigned:username=>{competitionUsername=username;const usernameEl=document.getElementById("competition-username-info");usernameEl&&(usernameEl.textContent=username),"block"===document.getElementById("leaderboard-panel").style.display&&(document.getElementById("username-display-info").style.display="block")}}):console.warn("LeaderboardClient not available")}async function enterCompetitionMode(){if(competitionMode)return;competitionMode=!0;const tabHeader=document.getElementById("demo-tab-header");tabHeader&&(tabHeader.style.display="none"),currentMode="competition";const demoContent=document.querySelector(".demo-tab-content");demoContent&&demoContent.classList.add("active"),updateModeUI(),initializeMode("competition"),document.getElementById("leaderboard-panel").style.display="block",document.getElementById("username-display-info").style.display="none",leaderboard&&!competitionCompleted&&(await leaderboard.connect(),leaderboard.setUserId("generate-username"),leaderboard.join(),console.log("Entered competition mode"))}function exitCompetitionMode(){if(!competitionMode)return;competitionMode=!1;const tabHeader=document.getElementById("demo-tab-header");tabHeader&&(tabHeader.style.display="flex"),currentMode="normal",document.querySelectorAll(".demo-tab-button").forEach(btn=>btn.classList.remove("active"));const normalButton=document.querySelector('.demo-tab-button[data-tab="normal"]');normalButton&&normalButton.classList.add("active"),updateModeUI(),initializeMode("normal"),document.getElementById("leaderboard-panel").style.display="none",leaderboard&&(leaderboard.leave(),leaderboard.disconnect()),console.log("Exited competition mode")}function submitCompetitionScore(markAsCompleted=!1){if(!leaderboard||!leaderboard.isReady())return;const totalScore=gameState.totalScore;if(leaderboard.updateScores({total_score:totalScore}),console.log(`Competition score updated: ${totalScore} (Attempt ${gameState.currentAttempt})`),markAsCompleted){competitionCompleted=!0;const statusEl=document.getElementById("status-comp");statusEl&&(statusEl.textContent="Complete! Score Submitted",statusEl.style.color="#28a745");const resetBtn=document.querySelector(".reset-button"),nextAttemptBtn=document.getElementById("next-attempt-btn");resetBtn&&(resetBtn.disabled=!0),nextAttemptBtn&&(nextAttemptBtn.style.display="none"),console.log("Competition completed. Final score:",totalScore)}}document.addEventListener("DOMContentLoaded",init);const infoTab=new InfoTab({onTabChange:tabName=>{"compete"===tabName?enterCompetitionMode():competitionMode&&exitCompetitionMode()}});