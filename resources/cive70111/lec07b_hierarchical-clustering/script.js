class HierarchicalClusteringDemo{constructor(){this.scatterCanvas=document.getElementById("scatter-plot"),this.dendrogramCanvas=document.getElementById("dendrogram-plot"),this.scatterOverlay=document.getElementById("scatter-overlay"),this.linkageSelect=document.getElementById("linkage-method"),this.stepBtn=document.getElementById("step-btn"),this.resetBtn=document.getElementById("reset-btn"),this.newDataBtn=document.getElementById("new-data-btn"),this.addDataModeCheckbox=document.getElementById("add-data-mode"),this.mergeCount=document.getElementById("merge-count"),this.clusterCount=document.getElementById("cluster-count"),this.pointsCount=document.getElementById("points-count"),this.scatterChart=null,this.dendrogramChart=null,this.xMin=-5,this.xMax=5,this.yMin=-5,this.yMax=5,this.xLabel="X",this.yLabel="Y",this.dataPoints=[],this.clusters=[],this.merges=[],this.linkageMethod="average",this.maxMergeDistance=1,this.clusterColors=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#34495e","#e67e22","#8e44ad","#16a085"],this.clusterColorMap=new Map,this.initializeScatterChart(),this.initializeDendrogramChart(),this.setupEventListeners(),requestAnimationFrame(()=>{this.setupOverlayCanvas(),this.generateInitialData()})}initializeScatterChart(){this.scatterCanvas.style.width="100%",this.scatterCanvas.style.height="100%",this.scatterChart=new Chart(this.scatterCanvas.getContext("2d"),{type:"scatter",data:{datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"linear",position:"bottom",min:this.xMin,max:this.xMax,title:{display:!0,text:this.xLabel,font:{size:14}},grid:{color:"rgba(0, 0, 0, 0.1)"}},y:{min:this.yMin,max:this.yMax,title:{display:!0,text:this.yLabel,font:{size:14}},grid:{color:"rgba(0, 0, 0, 0.1)"}}},plugins:{legend:{display:!1},tooltip:{enabled:!1}}}})}initializeDendrogramChart(){this.dendrogramCanvas.style.width="100%",this.dendrogramCanvas.style.height="100%",this.dendrogramChart=new Chart(this.dendrogramCanvas.getContext("2d"),{type:"line",data:{datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"linear",position:"bottom",min:0,max:10,title:{display:!0,text:"Leaf Position",font:{size:14}},grid:{color:"rgba(0, 0, 0, 0.1)"}},y:{min:0,max:1,title:{display:!0,text:"Merge Distance",font:{size:14}},grid:{color:"rgba(0, 0, 0, 0.1)"}}},plugins:{legend:{display:!1},tooltip:{enabled:!1}},elements:{point:{radius:0}}}})}setupOverlayCanvas(){const rect=this.scatterCanvas.getBoundingClientRect();this.scatterOverlay.width=rect.width*window.devicePixelRatio,this.scatterOverlay.height=rect.height*window.devicePixelRatio,this.scatterOverlay.style.width=rect.width+"px",this.scatterOverlay.style.height=rect.height+"px";this.scatterOverlay.getContext("2d").scale(window.devicePixelRatio,window.devicePixelRatio)}setupEventListeners(){this.linkageSelect.addEventListener("change",()=>{this.linkageMethod=this.linkageSelect.value,this.reset()}),this.stepBtn.addEventListener("click",()=>this.stepForward()),this.resetBtn.addEventListener("click",()=>this.reset()),this.newDataBtn.addEventListener("click",()=>this.generateInitialData()),this.scatterOverlay.addEventListener("click",e=>this.handleCanvasClick(e)),window.addEventListener("resize",()=>{this.setupOverlayCanvas(),this.updateVisualization()})}handleCanvasClick(e){if(!this.addDataModeCheckbox.checked)return;const rect=this.scatterOverlay.getBoundingClientRect(),x=e.clientX-rect.left,y=e.clientY-rect.top,xValue=this.scatterChart.scales.x.getValueForPixel(x),yValue=this.scatterChart.scales.y.getValueForPixel(y);void 0!==xValue&&void 0!==yValue&&(this.dataPoints.push([xValue,yValue]),this.reset())}generateInitialData(){this.dataPoints=[];for(let i=0;i<3;i++){const centerX=6*(Math.random()-.5),centerY=6*(Math.random()-.5);for(let j=0;j<6;j++){const x=centerX+2*(Math.random()-.5),y=centerY+2*(Math.random()-.5);this.dataPoints.push([x,y])}}this.reset()}reset(){this.clusters=this.dataPoints.map((point,i)=>({id:i,points:[point],centroid:[...point],children:null})),this.clusterColorMap.clear(),this.dataPoints.forEach((_,i)=>{this.clusterColorMap.set(i,this.clusterColors[i%this.clusterColors.length])}),this.merges=[],this.updateMaxMergeDistance(),this.updateDisplay(),this.updateVisualization()}calculateDistance(cluster1,cluster2){const method=this.linkageMethod;if("single"===method){let minDist=1/0;for(const p1 of cluster1.points)for(const p2 of cluster2.points){const dist=this.euclideanDistance(p1,p2);minDist=Math.min(minDist,dist)}return minDist}if("complete"===method){let maxDist=-1/0;for(const p1 of cluster1.points)for(const p2 of cluster2.points){const dist=this.euclideanDistance(p1,p2);maxDist=Math.max(maxDist,dist)}return maxDist}if("average"===method){let sum=0;for(const p1 of cluster1.points)for(const p2 of cluster2.points)sum+=this.euclideanDistance(p1,p2);return sum/(cluster1.points.length*cluster2.points.length)}if("ward"===method){const n1=cluster1.points.length,n2=cluster2.points.length,c1=cluster1.centroid,c2=cluster2.centroid,distSq=Math.pow(c1[0]-c2[0],2)+Math.pow(c1[1]-c2[1],2);return Math.sqrt(n1*n2*distSq/(n1+n2))}return 0}euclideanDistance(p1,p2){return Math.sqrt(Math.pow(p1[0]-p2[0],2)+Math.pow(p1[1]-p2[1],2))}stepForward(){if(this.clusters.length<=1)return;let minDist=1/0,mergeI=-1,mergeJ=-1;for(let i=0;i<this.clusters.length;i++)for(let j=i+1;j<this.clusters.length;j++){const dist=this.calculateDistance(this.clusters[i],this.clusters[j]);dist<minDist&&(minDist=dist,mergeI=i,mergeJ=j)}if(-1!==mergeI&&-1!==mergeJ){const cluster1=this.clusters[mergeI],cluster2=this.clusters[mergeJ],newPoints=[...cluster1.points,...cluster2.points],newCentroid=this.calculateCentroid(newPoints),newCluster={id:this.merges.length+this.dataPoints.length,points:newPoints,centroid:newCentroid,children:[cluster1,cluster2]},color1=this.clusterColorMap.get(cluster1.id),color2=this.clusterColorMap.get(cluster2.id),inheritColor=cluster1.points.length>=cluster2.points.length?color1:color2;this.clusterColorMap.set(newCluster.id,inheritColor),this.merges.push({cluster1:cluster1,cluster2:cluster2,distance:minDist,newCluster:newCluster}),this.clusters.splice(Math.max(mergeI,mergeJ),1),this.clusters.splice(Math.min(mergeI,mergeJ),1),this.clusters.push(newCluster),this.updateMaxMergeDistance()}this.updateDisplay(),this.updateVisualization()}calculateCentroid(points){const n=points.length;return[points.reduce((sum,p)=>sum+p[0],0)/n,points.reduce((sum,p)=>sum+p[1],0)/n]}updateMaxMergeDistance(){this.merges.length>0?this.maxMergeDistance=Math.max(...this.merges.map(m=>m.distance)):this.maxMergeDistance=1,0===this.maxMergeDistance&&(this.maxMergeDistance=1),this.dendrogramChart.options.scales.y.max=1.1*this.maxMergeDistance}updateDisplay(){this.mergeCount.textContent=this.merges.length,this.clusterCount.textContent=this.clusters.length,this.pointsCount.textContent=this.dataPoints.length}updateVisualization(){this.updateScatterPlot(),this.updateDendrogram()}updateScatterPlot(){const datasets=this.clusters.map((cluster,i)=>{const color=this.clusterColorMap.get(cluster.id)||this.clusterColors[i%this.clusterColors.length];return{label:`Cluster ${i+1}`,data:cluster.points.map(p=>({x:p[0],y:p[1]})),backgroundColor:color,borderColor:color,borderWidth:2,pointRadius:6,pointStyle:"circle"}});this.scatterChart.data.datasets=datasets,this.scatterChart.update("none")}updateDendrogram(){if(0===this.merges.length)return this.dendrogramChart.data.datasets=[],void this.dendrogramChart.update("none");const leafPositions={};let nextPosition=0;for(let i=0;i<this.dataPoints.length;i++)leafPositions[i]=nextPosition++;const datasets=[];for(const merge of this.merges){const pos1=this.getClusterPosition(merge.cluster1,leafPositions),pos2=this.getClusterPosition(merge.cluster2,leafPositions),avgPos=(pos1+pos2)/2;leafPositions[merge.newCluster.id]=avgPos;const height1=this.getClusterHeight(merge.cluster1),height2=this.getClusterHeight(merge.cluster2);datasets.push({data:[{x:pos1,y:height1},{x:pos1,y:merge.distance},{x:pos2,y:merge.distance},{x:pos2,y:height2}],borderColor:"#34495e",borderWidth:2,fill:!1,tension:0})}this.dendrogramChart.options.scales.x.max=Math.max(10,nextPosition),this.dendrogramChart.data.datasets=datasets,this.dendrogramChart.update("none")}getClusterPosition(cluster,leafPositions){if(null===cluster.children)return leafPositions[cluster.id];return(this.getClusterPosition(cluster.children[0],leafPositions)+this.getClusterPosition(cluster.children[1],leafPositions))/2}getClusterHeight(cluster){if(null===cluster.children)return 0;const merge=this.merges.find(m=>m.newCluster.id===cluster.id);return merge?merge.distance:0}}document.addEventListener("DOMContentLoaded",()=>{new InfoTab,new HierarchicalClusteringDemo});