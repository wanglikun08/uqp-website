class AgentColumn{constructor(algorithm,containerId){this.algorithm=algorithm,this.containerId=containerId;this.canvas=document.getElementById(`${containerId}-canvas`),this.chartCanvas=document.getElementById(`${containerId}-chart`),this.qTableCanvas=document.getElementById(`${containerId}-qtable`),this.avgReturnEl=document.getElementById(`${containerId}-avg-return`),this.greedyReturnEl=document.getElementById(`${containerId}-greedy-return`),this.epsilonEl=document.getElementById(`${containerId}-epsilon`),this.avgReturnEl&&this.avgReturnEl.classList.add("metriclabel-blue"),this.greedyReturnEl&&this.greedyReturnEl.classList.add("metriclabel-green"),this.epsilonEl&&this.epsilonEl.classList.add("metriclabel-purple"),this.cartpole=new CartPoleEnvironment;const{ctx:ctx,displayWidth:displayWidth,displayHeight:displayHeight}=CanvasHelper.setupHighDPI(this.canvas);this.ctx=ctx,this.displayWidth=displayWidth,this.displayHeight=displayHeight,this.scale=50,this.centerX=displayWidth/2,this.trackY=.7*displayHeight,this.cartWidth=40,this.cartHeight=30,this.qTableViz=new QTableVisualization(`${containerId}-qtable`),this.attemptCount=1,this.attemptLabel=document.getElementById(`${containerId}-attempt`),this.agent=null,this.checkpoint=null,this.isPlaying=!1,this.currentState=null,this.lastAction=null,this.lastActionTime=0,this.playToken=0,this.greedyAvgReturn=null,this.greedyEvalToken=0,this.playbackEpsilon=0,this.chart=null}loadSnapshot(checkpoint,checkpointIdx=-1){console.log(`Loading snapshot for ${this.algorithm}:`,checkpoint),this.checkpoint=checkpoint,this.checkpointIdx=checkpointIdx,this.agent=new TabularAgent(checkpoint,this.algorithm);const stats=checkpoint.statistics||{};this.greedyAvgReturn="number"==typeof stats.greedy_avg_return?stats.greedy_avg_return:null,this.updateMetrics(),null===this.greedyAvgReturn&&this.runGreedyEvaluation();const isInitial=0===checkpointIdx,chartCard=this.chartCanvas?.closest(".chart-card"),qtableCard=this.qTableCanvas?.closest(".qtable-card");chartCard&&(chartCard.style.display=isInitial?"none":""),qtableCard&&(qtableCard.style.display=isInitial?"none":""),isInitial||(this.qTableViz.updateHeatmap(this.agent.qTable,checkpoint.discretization),this.updateChart()),this.attemptCount=1,this.updateAttemptDisplay(),this.resetEpisode(),this.startPlaying()}updateMetrics(){if(!this.checkpoint)return;const stats=this.checkpoint.statistics||{},learningReturns=this.checkpoint.learning_curve?.returns||[];let avgReturn=stats.avg_return_last_100;if((0===avgReturn||void 0===avgReturn)&&learningReturns.length>0){const windowSize=Math.min(10,learningReturns.length);avgReturn=learningReturns.slice(-windowSize).reduce((sum,val)=>sum+val,0)/windowSize}const epsilon="number"==typeof stats.epsilon?stats.epsilon:0;if(this.avgReturnEl){const val="number"==typeof avgReturn?avgReturn.toFixed(1):"--";this.avgReturnEl.innerHTML=`<span class="metric-value">${val}</span><span class="metric-label">Training</span>`}if(this.greedyReturnEl){const val="number"==typeof this.greedyAvgReturn?this.greedyAvgReturn.toFixed(1):"...";this.greedyReturnEl.innerHTML=`<span class="metric-value">${val}</span><span class="metric-label">Greedy</span>`}this.epsilonEl&&(this.epsilonEl.innerHTML=`<span class="metric-value">${epsilon.toFixed(3)}</span><span class="metric-label">Epsilon</span>`)}async runGreedyEvaluation(){if(!this.agent)return;const token=++this.greedyEvalToken;this.greedyAvgReturn=null,this.updateMetrics();try{const greedyAvg=await this.evaluateGreedyPolicy(25);if(token!==this.greedyEvalToken)return;this.greedyAvgReturn=greedyAvg,this.updateMetrics()}catch(error){console.error(`Failed to evaluate greedy policy for ${this.algorithm}:`,error)}}updateChart(){if(!this.checkpoint||!this.chartCanvas)return void console.warn(`Cannot update chart for ${this.algorithm}: missing checkpoint or canvas`);const learningCurve=this.checkpoint.learning_curve;if(!learningCurve||!learningCurve.episodes||!learningCurve.returns)return void console.warn(`No learning curve data for ${this.algorithm}`);const steps=this.getLearningCurveSteps(),pointCount=Math.min(steps.length,learningCurve.returns.length);if(0===pointCount)return void console.warn(`Learning curve lacks step data for ${this.algorithm}`);console.log(`Updating chart for ${this.algorithm}:`,pointCount,"points"),this.chart&&this.chart.destroy();const chartData=Array.from({length:pointCount},(_,i)=>({x:steps[i],y:learningCurve.returns[i]}));this.chart=new Chart(this.chartCanvas,{type:"line",data:{datasets:[{label:"Episode Return",data:chartData,borderColor:this.getAlgorithmColor(),backgroundColor:this.getAlgorithmColor()+"33",borderWidth:2,pointRadius:0,tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,plugins:{legend:{display:!1}},scales:{x:{type:"linear",title:{display:!0,text:"Training Step"},ticks:{maxTicksLimit:5}},y:{title:{display:!0,text:"Return"},beginAtZero:!0}}}})}getAlgorithmColor(){return{"Monte Carlo":"#e74c3c",SARSA:"#3498db","Q-learning":"#2ecc71"}[this.algorithm]||"#95a5a6"}getLearningCurveSteps(){if(!this.checkpoint||!this.checkpoint.learning_curve)return[];const{learning_curve:learningCurve,step:step,episode:episode}=this.checkpoint,episodes=learningCurve.episodes||[];if(!episodes.length)return[];const totalSteps=step||0;if(!totalSteps)return episodes.map(()=>0);const maxEpisodeFromCurve=episodes[episodes.length-1]||0,referenceEpisode=Math.max(episode||0,maxEpisodeFromCurve,1),denominator=referenceEpisode>0?referenceEpisode:1,scale=denominator>0?totalSteps/denominator:0;return episodes.map(ep=>Math.round(ep*scale))}async evaluateGreedyPolicy(numEpisodes=25){if(!this.agent)return null;const evalEnv=new CartPoleEnvironment;let totalReturn=0;for(let ep=0;ep<numEpisodes;ep++){let state=evalEnv.reset(),episodeReturn=0,done=!1,steps=0;for(;!done&&steps<evalEnv.maxSteps;){const action=this.agent.selectAction(state,0),result=evalEnv.step(action);state=result.state,episodeReturn+=result.reward,done=result.done,steps+=1}totalReturn+=episodeReturn,ep%5==4&&await new Promise(resolve=>setTimeout(resolve,0))}return totalReturn/numEpisodes}resetEpisode(incrementAttempt=!1){incrementAttempt&&(this.attemptCount++,this.updateAttemptDisplay()),this.currentState=this.cartpole.reset(),this.render()}updateAttemptDisplay(){if(this.attemptLabel){const num=String(this.attemptCount).padStart(2,"0");this.attemptLabel.textContent=`Attempt: ${num}`}}stopPlaying(){this.isPlaying=!1}startPlaying(){this.playToken++,this.isPlaying=!0,this.playLoop(this.playToken)}render(){this.ctx.clearRect(0,0,this.displayWidth,this.displayHeight),this.ctx.fillStyle="#f8f9fa",this.ctx.fillRect(0,0,this.displayWidth,this.displayHeight);const leftX=this.centerX-this.cartpole.xThreshold*this.scale,rightX=this.centerX+this.cartpole.xThreshold*this.scale;this.ctx.strokeStyle="#cbd5e1",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(leftX,this.trackY),this.ctx.lineTo(rightX,this.trackY),this.ctx.stroke();const state=this.cartpole.state||{x:0,theta:0},cartX=this.centerX+state.x*this.scale,cartY=this.trackY,cartLeft=cartX-this.cartWidth/2,cartTop=cartY-this.cartHeight/2;this.ctx.fillStyle=this.getAlgorithmColor(),this.ctx.strokeStyle=this.getAlgorithmColor(),this.ctx.lineWidth=2,this.ctx.fillRect(cartLeft,cartTop,this.cartWidth,this.cartHeight),this.ctx.strokeRect(cartLeft,cartTop,this.cartWidth,this.cartHeight);const poleLength=2*this.cartpole.length*this.scale,poleX=cartX+poleLength*Math.sin(state.theta),poleY=cartTop-poleLength*Math.cos(state.theta);this.ctx.strokeStyle=this.getAlgorithmColor(),this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.moveTo(cartX,cartTop),this.ctx.lineTo(poleX,poleY),this.ctx.stroke(),this.ctx.fillStyle=this.getAlgorithmColor(),this.ctx.beginPath(),this.ctx.arc(poleX,poleY,6,0,2*Math.PI),this.ctx.fill(),this.drawForceIndicator(),this.cartpole.done&&"Time limit reached (10 seconds)"!==this.cartpole.terminationReason&&this.drawFailureX()}drawForceIndicator(){if(Date.now()-this.lastActionTime>500||null===this.lastAction)return;const ctx=this.ctx,boxX=this.displayWidth-36-8;ctx.fillStyle="rgba(255, 255, 255, 0.9)",ctx.strokeStyle="#cbd5e1",ctx.lineWidth=1,ctx.beginPath(),ctx.roundRect(boxX,8,36,36,4),ctx.fill(),ctx.stroke();const centerX=boxX+18;ctx.strokeStyle=this.getAlgorithmColor(),ctx.fillStyle=this.getAlgorithmColor(),ctx.lineWidth=5,ctx.lineCap="round";0===this.lastAction?(ctx.beginPath(),ctx.moveTo(centerX+6,26),ctx.lineTo(centerX-6,26),ctx.stroke(),ctx.beginPath(),ctx.moveTo(centerX-6-8,26),ctx.lineTo(centerX-6,19),ctx.lineTo(centerX-6,33),ctx.closePath(),ctx.fill()):1===this.lastAction&&(ctx.beginPath(),ctx.moveTo(centerX-6,26),ctx.lineTo(centerX+6,26),ctx.stroke(),ctx.beginPath(),ctx.moveTo(centerX+6+8,26),ctx.lineTo(centerX+6,19),ctx.lineTo(centerX+6,33),ctx.closePath(),ctx.fill())}drawFailureX(){const ctx=this.ctx,centerX=this.displayWidth/2,centerY=this.displayHeight/2,size=.3*Math.min(this.displayWidth,this.displayHeight);ctx.save(),ctx.strokeStyle="rgba(220, 53, 69, 0.7)",ctx.lineWidth=8,ctx.lineCap="round",ctx.beginPath(),ctx.moveTo(centerX-size,centerY-size),ctx.lineTo(centerX+size,centerY+size),ctx.stroke(),ctx.beginPath(),ctx.moveTo(centerX+size,centerY-size),ctx.lineTo(centerX-size,centerY+size),ctx.stroke(),ctx.restore()}async playLoop(token){for(;this.isPlaying&&token===this.playToken;)await this.stepEpisode(token),await new Promise(resolve=>setTimeout(resolve,50))}async stepEpisode(token){if(!this.agent||!this.currentState)return void this.resetEpisode();const action=this.agent.selectAction(this.currentState,this.playbackEpsilon);this.lastAction=action,this.lastActionTime=Date.now();const result=this.cartpole.step(action);this.currentState=result.state,this.render(),result.done&&(await new Promise(resolve=>setTimeout(resolve,500)),token===this.playToken&&this.resetEpisode(!0))}}class QLearningDemo{constructor(){this.loader=new SnapshotLoader,this.mcColumn=null,this.sarsaColumn=null,this.qlearnColumn=null,this.currentCheckpointIdx=0,this.checkpointButtons=[]}async initialize(){try{console.log("Initializing Q-learning demo..."),await this.loader.loadAllCheckpoints(),console.log("Checkpoints loaded successfully"),this.mcColumn=new AgentColumn("Monte Carlo","mc"),this.sarsaColumn=new AgentColumn("SARSA","sarsa"),this.qlearnColumn=new AgentColumn("Q-learning","qlearning"),console.log("Agent columns created"),this.setupCheckpointButtons(),console.log("Checkpoint buttons setup, count:",this.checkpointButtons.length),this.loadCheckpoint(0),console.log("Q-learning demo initialized successfully")}catch(error){console.error("Failed to initialize demo:",error),this.showError(error.message)}}setupCheckpointButtons(){this.checkpointButtons=Array.from(document.querySelectorAll(".checkpoint-btn")),this.checkpointButtons.forEach((btn,idx)=>{btn.addEventListener("click",()=>this.loadCheckpoint(idx))}),this.checkpointButtons.length>0&&this.checkpointButtons[0].classList.add("active")}loadCheckpoint(checkpointIdx){console.log(`Loading checkpoint ${checkpointIdx}`),this.stopAll(),this.currentCheckpointIdx=checkpointIdx,this.checkpointButtons.forEach((btn,idx)=>{idx===checkpointIdx?btn.classList.add("active"):btn.classList.remove("active")});try{const mcCheckpoint=this.loader.getCheckpoint("mc",checkpointIdx),sarsaCheckpoint=this.loader.getCheckpoint("sarsa",checkpointIdx),qlearnCheckpoint=this.loader.getCheckpoint("qlearning",checkpointIdx);console.log("Checkpoints retrieved:",{mc:mcCheckpoint?"OK":"MISSING",sarsa:sarsaCheckpoint?"OK":"MISSING",qlearning:qlearnCheckpoint?"OK":"MISSING"}),this.mcColumn.loadSnapshot(mcCheckpoint,checkpointIdx),this.sarsaColumn.loadSnapshot(sarsaCheckpoint,checkpointIdx),this.qlearnColumn.loadSnapshot(qlearnCheckpoint,checkpointIdx),this.updateTeachingCallout(checkpointIdx)}catch(error){console.error("Failed to load checkpoint:",error),this.showError(error.message)}}updateTeachingCallout(checkpointIdx){const configElement=document.getElementById("current-config"),tipElement=document.getElementById("teaching-tip"),configs=["Initial training (0 steps)","Early training (10,000 steps)","Mid-training (80,000 steps)","Converged (150,000 steps)"],messages=["Initial training - watch all three agents fail to balance!","Early training with moderate exploration (ε is still high). Notice MC updates only at episode end.","Mid-training: SARSA uses actual next action, Q-learning uses max. Compare Q-tables side-by-side!","Near-optimal policies. Q-table size: 625 states × 2 actions = 1,250 values. Imagine millions of states!"];configElement&&(configElement.textContent="Currently viewing: "+configs[checkpointIdx]),tipElement&&(tipElement.textContent=messages[checkpointIdx]||"")}showError(message){const errorDiv=document.createElement("div");errorDiv.className="error-message",errorDiv.textContent=`Error: ${message}`,errorDiv.style.cssText="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #e74c3c; color: white; padding: 15px 30px; border-radius: 5px; z-index: 1000;",document.body.appendChild(errorDiv),setTimeout(()=>errorDiv.remove(),5e3)}stopAll(){this.mcColumn&&this.mcColumn.stopPlaying(),this.sarsaColumn&&this.sarsaColumn.stopPlaying(),this.qlearnColumn&&this.qlearnColumn.stopPlaying()}}let demo;window.addEventListener("DOMContentLoaded",async()=>{demo=new QLearningDemo,await demo.initialize(),new InfoTab});