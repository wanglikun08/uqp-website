class QTableVisualization{constructor(canvasId){this.canvas=document.getElementById(canvasId),this.ctx=this.canvas.getContext("2d");const dpr=window.devicePixelRatio||1,displayWidth=this.canvas.clientWidth,displayHeight=this.canvas.clientHeight;this.canvas.width=displayWidth*dpr,this.canvas.height=displayHeight*dpr,this.canvas.style.width=displayWidth+"px",this.canvas.style.height=displayHeight+"px",this.ctx.scale(dpr,dpr),this.width=displayWidth,this.height=displayHeight,this.padding={left:60,right:100,top:40,bottom:60},this.gridWidth=this.width-this.padding.left-this.padding.right,this.gridHeight=this.height-this.padding.top-this.padding.bottom,this.qTableData=null,this.discretization=null,this.qMin=0,this.qMax=1}updateHeatmap(qTableData,discretization){this.qTableData=qTableData,this.discretization=discretization,this.calculateQRange(),this.render()}calculateQRange(){if(!this.qTableData)return;let min=1/0,max=-1/0;for(let i=0;i<this.qTableData.length;i++)for(let j=0;j<this.qTableData[i].length;j++)for(let k=0;k<this.qTableData[i][j].length;k++)for(let l=0;l<this.qTableData[i][j][k].length;l++)for(let m=0;m<this.qTableData[i][j][k][l].length;m++){const val=this.qTableData[i][j][k][l][m];val<min&&(min=val),val>max&&(max=val)}this.qMin=min,this.qMax=max}render(){this.qTableData&&this.discretization?(this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.width,this.height),this.renderHeatmap(),this.renderActionArrows(),this.renderAxes(),this.renderColorbar()):this.renderPlaceholder()}renderPlaceholder(){this.ctx.fillStyle="#f5f5f5",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.fillStyle="#999999",this.ctx.font="14px sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Loading Q-table...",this.width/2,this.height/2)}renderHeatmap(){const dimensions=this.getDimensionSizes();if(!dimensions.thetaBins||!dimensions.thetaDotBins)return void this.renderPlaceholder();const x_idx=this.getNearestBinToZero(this.discretization?.x_bins,dimensions.xBins),x_dot_idx=this.getNearestBinToZero(this.discretization?.x_dot_bins,dimensions.xDotBins),cellWidth=this.gridWidth/dimensions.thetaBins,cellHeight=this.gridHeight/dimensions.thetaDotBins;for(let theta_idx=0;theta_idx<dimensions.thetaBins;theta_idx++)for(let theta_dot_idx=0;theta_dot_idx<dimensions.thetaDotBins;theta_dot_idx++){const qValues=this.qTableData?.[x_idx]?.[x_dot_idx]?.[theta_idx]?.[theta_dot_idx];if(!qValues)continue;const maxQ=Math.max(...qValues),color=this.getColor(maxQ),x=this.padding.left+theta_idx*cellWidth,y=this.padding.top+(dimensions.thetaDotBins-1-theta_dot_idx)*cellHeight;this.ctx.fillStyle=color,this.ctx.fillRect(x,y,cellWidth,cellHeight),this.ctx.strokeStyle="#cccccc",this.ctx.lineWidth=1,this.ctx.strokeRect(x,y,cellWidth,cellHeight)}}renderActionArrows(){const dimensions=this.getDimensionSizes();if(!dimensions.thetaBins||!dimensions.thetaDotBins)return;const x_idx=this.getNearestBinToZero(this.discretization?.x_bins,dimensions.xBins),x_dot_idx=this.getNearestBinToZero(this.discretization?.x_dot_bins,dimensions.xDotBins),cellWidth=this.gridWidth/dimensions.thetaBins,cellHeight=this.gridHeight/dimensions.thetaDotBins;for(let theta_idx=0;theta_idx<dimensions.thetaBins;theta_idx++)for(let theta_dot_idx=0;theta_dot_idx<dimensions.thetaDotBins;theta_dot_idx++){const qValues=this.qTableData?.[x_idx]?.[x_dot_idx]?.[theta_idx]?.[theta_dot_idx];if(!qValues)continue;let bestAction=0,maxQ=qValues[0];for(let a=1;a<qValues.length;a++)qValues[a]>maxQ&&(maxQ=qValues[a],bestAction=a);const x=this.padding.left+(theta_idx+.5)*cellWidth,y=this.padding.top+(dimensions.thetaDotBins-theta_dot_idx-.5)*cellHeight;this.drawActionArrow(x,y,bestAction,.6*cellWidth)}}drawActionArrow(x,y,action,length){const arrowLength=.4*length;if(this.ctx.save(),this.ctx.strokeStyle="#000000",this.ctx.fillStyle="#000000",this.ctx.lineWidth=2,this.ctx.lineCap="round",0===action){const x1=x+arrowLength/2,x2=x-arrowLength/2;this.ctx.beginPath(),this.ctx.moveTo(x1,y),this.ctx.lineTo(x2,y),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(x2,y),this.ctx.lineTo(x2+6,y-3),this.ctx.lineTo(x2+6,y+3),this.ctx.closePath(),this.ctx.fill()}else{const x1=x-arrowLength/2,x2=x+arrowLength/2;this.ctx.beginPath(),this.ctx.moveTo(x1,y),this.ctx.lineTo(x2,y),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(x2,y),this.ctx.lineTo(x2-6,y-3),this.ctx.lineTo(x2-6,y+3),this.ctx.closePath(),this.ctx.fill()}this.ctx.restore()}renderAxes(){this.ctx.fillStyle="#333333",this.ctx.strokeStyle="#333333",this.ctx.lineWidth=2,this.ctx.font="12px sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText("θ (angle)",this.padding.left+this.gridWidth/2,this.height-25),this.ctx.save(),this.ctx.translate(15,this.padding.top+this.gridHeight/2),this.ctx.rotate(-Math.PI/2),this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText("θ̇ (angular velocity)",0,0),this.ctx.restore(),this.ctx.font="10px sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="top";const dimensions=this.getDimensionSizes(),thetaLabels=this.getBinCenters(this.discretization?.theta_bins),thetaCount=thetaLabels.length||dimensions.thetaBins||5,thetaCellWidth=this.gridWidth/thetaCount;for(let i=0;i<thetaCount;i++){const x=this.padding.left+(i+.5)*thetaCellWidth,y=this.padding.top+this.gridHeight+5,label=void 0!==thetaLabels[i]?thetaLabels[i].toFixed(2):"";this.ctx.fillText(label,x,y)}const thetaDotLabels=this.getBinCenters(this.discretization?.theta_dot_bins);this.ctx.textAlign="right",this.ctx.textBaseline="middle";const thetaDotCount=thetaDotLabels.length||dimensions.thetaDotBins||5,thetaDotCellHeight=this.gridHeight/thetaDotCount;for(let i=0;i<thetaDotCount;i++){const x=this.padding.left-5,y=this.padding.top+(thetaDotCount-i-.5)*thetaDotCellHeight,label=void 0!==thetaDotLabels[i]?thetaDotLabels[i].toFixed(2):"";this.ctx.fillText(label,x,y)}}renderColorbar(){const barHeight=this.gridHeight,barX=this.width-this.padding.right+20,barY=this.padding.top,stepHeight=barHeight/50;for(let i=0;i<50;i++){const t=i/49,qValue=this.qMin+t*(this.qMax-this.qMin),color=this.getColor(qValue);this.ctx.fillStyle=color,this.ctx.fillRect(barX,barY+(49-i)*stepHeight,20,stepHeight)}this.ctx.strokeStyle="#333333",this.ctx.lineWidth=1,this.ctx.strokeRect(barX,barY,20,barHeight),this.ctx.fillStyle="#333333",this.ctx.font="10px sans-serif",this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(this.qMax.toFixed(1),barX+20+5,barY),this.ctx.fillText(this.qMin.toFixed(1),barX+20+5,barY+barHeight),this.ctx.fillText("Q-value",barX+20+5,barY+barHeight/2)}getColor(qValue){const t=(qValue-this.qMin)/(this.qMax-this.qMin||1),viridis=[[68,1,84],[59,82,139],[33,145,140],[94,201,98],[253,231,37]],idx=Math.min(Math.floor(t*(viridis.length-1)),viridis.length-2),localT=t*(viridis.length-1)-idx,c1=viridis[idx],c2=viridis[idx+1];return`rgb(${Math.round(c1[0]+(c2[0]-c1[0])*localT)}, ${Math.round(c1[1]+(c2[1]-c1[1])*localT)}, ${Math.round(c1[2]+(c2[2]-c1[2])*localT)})`}getDimensionSizes(){const xBins=this.qTableData?this.qTableData.length:0,xDotBins=xBins&&this.qTableData[0]?.length||0,thetaBins=xDotBins&&this.qTableData[0][0]?.length||0;return{xBins:xBins,xDotBins:xDotBins,thetaBins:thetaBins,thetaDotBins:thetaBins&&this.qTableData[0][0][0]?.length||0}}getNearestBinToZero(bins,sizeFallback){if(Array.isArray(bins)&&bins.length>1){let minDist=1/0,bestIdx=0;for(let i=0;i<bins.length-1;i++){const center=(bins[i]+bins[i+1])/2,dist=Math.abs(center);dist<minDist&&(minDist=dist,bestIdx=i)}return bestIdx}return sizeFallback&&sizeFallback>0?Math.floor(sizeFallback/2):0}getBinCenters(bins){if(!Array.isArray(bins)||bins.length<2)return[];const centers=[];for(let i=0;i<bins.length-1;i++)centers.push((bins[i]+bins[i+1])/2);return centers}}